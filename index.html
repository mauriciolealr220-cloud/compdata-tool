<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CompObj Compact Editor</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    font-size: 12px;
    color: #222;
    background: #f5f6f8;
    margin: 0;
    padding: 20px;
  }

  #container {
    max-width: 1200px;
    margin: auto;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    padding: 12px;
  }

  #sheet-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }

  #sheet-tabs button {
    flex: 0 0 auto;
    border-radius: 6px 6px 0 0;
    border-bottom: none;
    padding: 6px 14px;
    font-weight: 600;
    background: #e9eef5;
  }

  #sheet-tabs button.active {
    background: #fff;
    border-color: #c5d3e3;
    border-bottom: 1px solid #fff;
  }

  #controls {
    border: 1px solid #e3e7ef;
    border-top: none;
    border-radius: 0 6px 6px 6px;
    background: #fff;
    margin-bottom: 10px;
  }

  #controls .control-set {
    display: none;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px;
  }

  #controls .control-set.active {
    display: flex;
  }

  button {
    font-size: 12px;
    border: 1px solid #ccc;
    background: #fff;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    transition: 0.1s;
  }
  button:hover { background: #f2f2f2; }

  input[type="number"] {
    width: 45px;
    font-size: 12px;
    padding: 2px 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }

  input[type="file"] { display: none; }

  #lineCount {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #eee;
    padding: 3px 6px;
    height: 24px;
    text-align: left;
    background: #fff;
  }

  th {
    background: #f9fafb;
    font-weight: 600;
    font-size: 12px;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  td input {
    width: 100%;
    border: none;
    outline: none;
    font: inherit;
    background: transparent;
    padding: 2px 3px;
    height: 20px;
    color: #222;
  }

  td.num input { text-align: center; color: #333; }

  /* Colored side tags */
  tr.stage td:first-child { border-left: 3px solid #90c4ff; }
  tr.group td:first-child { border-left: 3px solid #ffb870; }
  tr.final td:first-child { border-left: 3px solid #bba7ff; }
  tr.schedule-row td:first-child { border-left: 3px solid #86d4ff; }

  tr:hover td { background: #f5faff; }
  tr.selected td { background: #e9f3ff !important; outline: 1px solid #0078d7; }

  td.highlight-auto { background: #e3f1ff !important; transition: background-color 0.3s ease-in-out; }

  #sheet tr:nth-child(even) td { background: #fdf7ef; }

  #table-wrapper {
    height: 85vh;
    overflow-y: auto;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }
</style>
</head>
<body>

  <div id="container">
    <div id="sheet-tabs">
      <button id="tab-compobj" class="active" onclick="setActiveSheet('compobj')">🧩 CompObj</button>
      <button id="tab-schedule" onclick="setActiveSheet('schedule')">📅 Schedule</button>
      <button id="tab-advancement" onclick="setActiveSheet('advancement')">🏆 Advancement</button>
      <button id="tab-standings" onclick="setActiveSheet('standings')">📊 Standings</button>
      <button id="tab-settings" onclick="setActiveSheet('settings')">⚙️ Settings</button>
      <button id="tab-tasks" onclick="setActiveSheet('tasks')">🧠 Tasks</button>
      <button id="tab-weather" onclick="setActiveSheet('weather')">🌦️ Weather</button>
    </div>
    <div id="controls">
      <div class="control-set active" data-sheet-controls="compobj">
        <button onclick="triggerFileDialog('compobj','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-compobj-import" accept=".txt,.csv" onchange="importFile(event,false,'compobj')">
        <button onclick="triggerFileDialog('compobj','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-compobj-append" accept=".txt,.csv" onchange="importFile(event,true,'compobj')">
        <button onclick="addRow('compobj')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-compobj" min="1" value="1">
        <button onclick="insertRows('compobj','above')">↑ Insert Above</button>
        <button onclick="insertRows('compobj','below')">↓ Insert Below</button>
        <button onclick="deleteRow('compobj')">− Delete Selected</button>
        <button onclick="exportTxt('compobj')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="schedule">
        <button onclick="triggerFileDialog('schedule','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-schedule-import" accept=".txt,.csv" onchange="importFile(event,false,'schedule')">
        <button onclick="triggerFileDialog('schedule','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-schedule-append" accept=".txt,.csv" onchange="importFile(event,true,'schedule')">
        <button onclick="addRow('schedule')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-schedule" min="1" value="1">
        <button onclick="insertRows('schedule','above')">↑ Insert Above</button>
        <button onclick="insertRows('schedule','below')">↓ Insert Below</button>
        <button onclick="deleteRow('schedule')">− Delete Selected</button>
        <button onclick="exportTxt('schedule')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="advancement">
        <button onclick="triggerFileDialog('advancement','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-advancement-import" accept=".txt,.csv" onchange="importFile(event,false,'advancement')">
        <button onclick="triggerFileDialog('advancement','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-advancement-append" accept=".txt,.csv" onchange="importFile(event,true,'advancement')">
        <button onclick="addRow('advancement')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-advancement" min="1" value="1">
        <button onclick="insertRows('advancement','above')">↑ Insert Above</button>
        <button onclick="insertRows('advancement','below')">↓ Insert Below</button>
        <button onclick="deleteRow('advancement')">− Delete Selected</button>
        <button onclick="exportTxt('advancement')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="standings">
        <button onclick="triggerFileDialog('standings','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-standings-import" accept=".txt,.csv" onchange="importFile(event,false,'standings')">
        <button onclick="triggerFileDialog('standings','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-standings-append" accept=".txt,.csv" onchange="importFile(event,true,'standings')">
        <button onclick="addRow('standings')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-standings" min="1" value="1">
        <button onclick="insertRows('standings','above')">↑ Insert Above</button>
        <button onclick="insertRows('standings','below')">↓ Insert Below</button>
        <button onclick="deleteRow('standings')">− Delete Selected</button>
        <button onclick="exportTxt('standings')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="settings">
        <button onclick="triggerFileDialog('settings','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-settings-import" accept=".txt,.csv" onchange="importFile(event,false,'settings')">
        <button onclick="triggerFileDialog('settings','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-settings-append" accept=".txt,.csv" onchange="importFile(event,true,'settings')">
        <button onclick="addRow('settings')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-settings" min="1" value="1">
        <button onclick="insertRows('settings','above')">↑ Insert Above</button>
        <button onclick="insertRows('settings','below')">↓ Insert Below</button>
        <button onclick="deleteRow('settings')">− Delete Selected</button>
        <button onclick="exportTxt('settings')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="tasks">
        <button onclick="triggerFileDialog('tasks','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-tasks-import" accept=".txt,.csv" onchange="importFile(event,false,'tasks')">
        <button onclick="triggerFileDialog('tasks','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-tasks-append" accept=".txt,.csv" onchange="importFile(event,true,'tasks')">
        <button onclick="addRow('tasks')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-tasks" min="1" value="1">
        <button onclick="insertRows('tasks','above')">↑ Insert Above</button>
        <button onclick="insertRows('tasks','below')">↓ Insert Below</button>
        <button onclick="deleteRow('tasks')">− Delete Selected</button>
        <button onclick="exportTxt('tasks')">💾 Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="weather">
        <button onclick="triggerFileDialog('weather','import')">📂 Import .txt</button>
        <input type="file" id="fileInput-weather-import" accept=".txt,.csv" onchange="importFile(event,false,'weather')">
        <button onclick="triggerFileDialog('weather','append')">➕ Append .txt</button>
        <input type="file" id="fileInput-weather-append" accept=".txt,.csv" onchange="importFile(event,true,'weather')">
        <button onclick="addRow('weather')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-weather" min="1" value="1">
        <button onclick="insertRows('weather','above')">↑ Insert Above</button>
        <button onclick="insertRows('weather','below')">↓ Insert Below</button>
        <button onclick="deleteRow('weather')">− Delete Selected</button>
        <button onclick="exportTxt('weather')">💾 Export .txt</button>
      </div>
    </div>

  <div id="lineCount"></div>

  <div id="table-wrapper">
    <table id="sheet"></table>
  </div>
</div>

<script>
let compobj = [];
let schedule = [];
let advancement = [];
let standings = [];
let settings = [];
let tasks = [];
let weather = [];
let activeSheet = 'compobj';
const selections = { compobj: null, schedule: null, advancement: null, standings: null, settings: null, tasks: null, weather: null };
let tempIdCounter = 0;
const DYNAMIC_TASK_TYPES = new Set(['updatetable', 'fillfromcomptable']);
const TASK_HIGHLIGHT_DURATION = 5000;
const taskHighlightMap = new Map();

function shouldUpdateTaskRefId(taskType) {
  const normalized = (taskType || '').trim().toLowerCase();
  return DYNAMIC_TASK_TYPES.has(normalized);
}

function markTaskHighlight(rowIndex, columnKey) {
  if (!taskHighlightMap.has(rowIndex)) {
    taskHighlightMap.set(rowIndex, { columns: new Set(), timers: new Map() });
  }
  const entry = taskHighlightMap.get(rowIndex);
  if (!entry.columns.has(columnKey)) {
    entry.columns.add(columnKey);
  }
  const timers = entry.timers;
  const existing = timers.get(columnKey);
  if (existing) {
    clearTimeout(existing);
  }
  const timeoutId = setTimeout(() => {
    const current = taskHighlightMap.get(rowIndex);
    if (!current) return;
    current.columns.delete(columnKey);
    current.timers.delete(columnKey);
    if (current.columns.size === 0) {
      taskHighlightMap.delete(rowIndex);
    }
    if (activeSheet === 'tasks') {
      render();
    }
  }, TASK_HIGHLIGHT_DURATION);
  timers.set(columnKey, timeoutId);
}

function clearTaskHighlights() {
  taskHighlightMap.forEach((entry) => {
    entry.timers.forEach((timeoutId) => clearTimeout(timeoutId));
  });
  taskHighlightMap.clear();
}

function safe(value) {
  return (value ?? '').toString()
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function getRowClass(r) {
  if (!r.code && !r.name) return "";
  const code = (r.code || "").toUpperCase();
  const name = (r.name || "").toUpperCase();
  if (code.startsWith("S")) return "stage";
  if (code.startsWith("G")) return "group";
  if (name.includes("FINAL") || name.includes("PLAYOFF")) return "final";
  return "";
}

function createDefaultCompobjRow() {
  return { id: `__temp-${tempIdCounter++}`, depth: 5, code: '', name: '', parentDisplay: '' };
}

function renumberCompobjIds() {
  const idMap = new Map();

  compobj.forEach((row, index) => {
    const oldId = row.id == null ? '' : String(row.id);
    const newId = String(index);
    if (oldId !== '') {
      idMap.set(oldId, newId);
    }
    row.id = newId;
  });

  compobj.forEach((row) => {
    const parent = row.parentDisplay == null ? '' : String(row.parentDisplay);
    if (parent === '') return;
    const mapped = idMap.get(parent);
    if (mapped !== undefined) {
      row.parentDisplay = mapped;
    }
  });

  schedule = schedule.map((row) => {
    const current = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (current === '') return row;
    const mapped = idMap.get(current);
    if (mapped === undefined) return row;
    return { ...row, stageGroupId: mapped };
  });

  advancement = advancement.map((row) => {
    const source = row.sourceGroupId == null ? '' : String(row.sourceGroupId);
    const target = row.targetGroupId == null ? '' : String(row.targetGroupId);
    const mappedSource = source !== '' ? idMap.get(source) : undefined;
    const mappedTarget = target !== '' ? idMap.get(target) : undefined;
    if (mappedSource === undefined && mappedTarget === undefined) return row;
    return {
      ...row,
      sourceGroupId: mappedSource !== undefined ? mappedSource : row.sourceGroupId,
      targetGroupId: mappedTarget !== undefined ? mappedTarget : row.targetGroupId
    };
  });

  standings = standings.map((row) => {
    const group = row.groupId == null ? '' : String(row.groupId);
    if (group === '') return row;
    const mapped = idMap.get(group);
    if (mapped === undefined) return row;
    return { ...row, groupId: mapped };
  });

  settings = settings.map((row) => {
    const stageGroup = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (stageGroup === '') return row;
    const mapped = idMap.get(stageGroup);
    if (mapped === undefined) return row;
    return { ...row, stageGroupId: mapped };
  });

  updateWeatherIds(idMap);
  updateTaskIds(idMap);
}

function updateWeatherIds(idMap) {
  if (weather.length === 0) return;
  weather = weather.map((row) => {
    const nation = row.nationId == null ? '' : String(row.nationId);
    if (nation === '') return row;
    const mapped = idMap.get(nation);
    if (mapped === undefined) return row;
    return { ...row, nationId: mapped };
  });
}

function updateTaskIds(idMap) {
  if (tasks.length === 0) return;
  tasks = tasks.map((row, index) => {
    let nextRow = row;
    let changed = false;

    const trophy = row.trophyId == null ? '' : String(row.trophyId);
    if (trophy !== '') {
      const mappedTrophy = idMap.get(trophy);
      if (mappedTrophy !== undefined && mappedTrophy !== row.trophyId) {
        if (!changed) nextRow = { ...nextRow };
        nextRow.trophyId = mappedTrophy;
        markTaskHighlight(index, 'trophyId');
        changed = true;
      }
    }

    const target = row.targetId == null ? '' : String(row.targetId);
    if (target !== '') {
      const mappedTarget = idMap.get(target);
      if (mappedTarget !== undefined && mappedTarget !== row.targetId) {
        if (!changed) nextRow = { ...nextRow };
        nextRow.targetId = mappedTarget;
        markTaskHighlight(index, 'targetId');
        changed = true;
      }
    }

    const reference = row.refId == null ? '' : String(row.refId);
    if (reference !== '' && shouldUpdateTaskRefId(row.taskType)) {
      const mappedReference = idMap.get(reference);
      if (mappedReference !== undefined && mappedReference !== row.refId) {
        if (!changed) nextRow = { ...nextRow };
        nextRow.refId = mappedReference;
        markTaskHighlight(index, 'refId');
        changed = true;
      }
    }

    return changed ? nextRow : row;
  });
}

function syncTasksForManualIdChange(previous, next) {
  if (tasks.length === 0) return;
  const prevValue = previous == null ? '' : String(previous);
  const nextValue = next == null ? '' : String(next);
  if (prevValue === nextValue) return;

  tasks = tasks.map((row, index) => {
    let nextRow = row;
    let changed = false;

    const trophy = row.trophyId == null ? '' : String(row.trophyId);
    if (trophy === prevValue) {
      if (!changed) nextRow = { ...nextRow };
      nextRow.trophyId = nextValue;
      markTaskHighlight(index, 'trophyId');
      changed = true;
    }

    const target = row.targetId == null ? '' : String(row.targetId);
    if (target === prevValue) {
      if (!changed) nextRow = { ...nextRow };
      nextRow.targetId = nextValue;
      markTaskHighlight(index, 'targetId');
      changed = true;
    }

    const reference = row.refId == null ? '' : String(row.refId);
    if (reference === prevValue && shouldUpdateTaskRefId(row.taskType)) {
      if (!changed) nextRow = { ...nextRow };
      nextRow.refId = nextValue;
      markTaskHighlight(index, 'refId');
      changed = true;
    }

    return changed ? nextRow : row;
  });
}

function syncReferencesForManualIdChange(oldValue, newValue) {
  const previous = oldValue == null ? '' : String(oldValue);
  const next = newValue == null ? '' : String(newValue);
  if (previous === next) return;

  compobj.forEach((row) => {
    const parent = row.parentDisplay == null ? '' : String(row.parentDisplay);
    if (parent === previous) {
      row.parentDisplay = next;
    }
  });

  schedule = schedule.map((row) => {
    const current = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (current !== previous) return row;
    return { ...row, stageGroupId: next };
  });

  advancement = advancement.map((row) => {
    const source = row.sourceGroupId == null ? '' : String(row.sourceGroupId);
    const target = row.targetGroupId == null ? '' : String(row.targetGroupId);
    let changed = false;
    let newSource = row.sourceGroupId;
    let newTarget = row.targetGroupId;
    if (source === previous) {
      newSource = next;
      changed = true;
    }
    if (target === previous) {
      newTarget = next;
      changed = true;
    }
    return changed ? { ...row, sourceGroupId: newSource, targetGroupId: newTarget } : row;
  });

  standings = standings.map((row) => {
    const group = row.groupId == null ? '' : String(row.groupId);
    if (group !== previous) return row;
    return { ...row, groupId: next };
  });

  settings = settings.map((row) => {
    const stageGroup = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (stageGroup !== previous) return row;
    return { ...row, stageGroupId: next };
  });

  weather = weather.map((row) => {
    const nation = row.nationId == null ? '' : String(row.nationId);
    if (nation !== previous) return row;
    return { ...row, nationId: next };
  });

  syncTasksForManualIdChange(previous, next);
}

function render() {
  const table = document.getElementById("sheet");
  const lineCount = document.getElementById("lineCount");
  document.getElementById('tab-compobj').classList.toggle('active', activeSheet === 'compobj');
  document.getElementById('tab-schedule').classList.toggle('active', activeSheet === 'schedule');
  document.getElementById('tab-advancement').classList.toggle('active', activeSheet === 'advancement');
  document.getElementById('tab-standings').classList.toggle('active', activeSheet === 'standings');
  document.getElementById('tab-settings').classList.toggle('active', activeSheet === 'settings');
  document.getElementById('tab-tasks').classList.toggle('active', activeSheet === 'tasks');
  document.getElementById('tab-weather').classList.toggle('active', activeSheet === 'weather');
  updateControlVisibility();

  let countLabel = '';
  if (activeSheet === 'compobj') {
    countLabel = `CompObj: ${compobj.length} lines parsed`;
  } else if (activeSheet === 'schedule') {
    countLabel = `Schedule: ${schedule.length} entries parsed`;
  } else if (activeSheet === 'advancement') {
    countLabel = `Advancement: ${advancement.length} links parsed`;
  } else if (activeSheet === 'standings') {
    countLabel = `Standings: ${standings.length} slots parsed`;
  } else if (activeSheet === 'weather') {
    countLabel = `Weather: ${weather.length} rows parsed`;
  } else if (activeSheet === 'tasks') {
    countLabel = `Tasks: ${tasks.length} automation rows parsed`;
  } else {
    countLabel = `Settings: ${settings.length} entries parsed`;
  }
  lineCount.textContent = countLabel;

  if (activeSheet === 'compobj') {
    table.innerHTML = `
      <tr>
        <th style="width:32px;">#</th>
        <th style="width:70px;">ID</th>
        <th style="width:60px;">Level</th>
        <th style="width:80px;">Code</th>
        <th>Name</th>
        <th style="width:70px;">Parent</th>
      </tr>
      ${compobj.map((r, i) => `
        <tr class="${getRowClass(r)} ${selections.compobj===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.id)}" oninput="updateField(${i},'id',this.value)"></td>
          <td class="num"><input value="${safe(r.depth)}" oninput="updateField(${i},'depth',this.value)"></td>
          <td><input value="${safe(r.code)}" oninput="updateField(${i},'code',this.value)"></td>
          <td><input value="${safe(r.name)}" oninput="updateField(${i},'name',this.value)"></td>
          <td class="num"><input value="${safe(r.parentDisplay)}" oninput="updateField(${i},'parentDisplay',this.value)"></td>
        </tr>
      `).join("")}`;
  } else if (activeSheet === 'schedule') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Stage/Group ID</th>
        <th style="width:80px;">Day ID</th>
        <th style="width:90px;">Matchday</th>
        <th style="width:100px;">Min Matches</th>
        <th style="width:100px;">Max Matches</th>
        <th style="width:80px;">Time</th>
      </tr>
      ${schedule.map((r, i) => `
        <tr class="schedule-row ${selections.schedule===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.stageGroupId)}" oninput="updateField(${i},'stageGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.dayId)}" oninput="updateField(${i},'dayId',this.value)"></td>
          <td class="num"><input value="${safe(r.matchday)}" oninput="updateField(${i},'matchday',this.value)"></td>
          <td class="num"><input value="${safe(r.minMatches)}" oninput="updateField(${i},'minMatches',this.value)"></td>
          <td class="num"><input value="${safe(r.maxMatches)}" oninput="updateField(${i},'maxMatches',this.value)"></td>
          <td class="num"><input value="${safe(r.time)}" oninput="updateField(${i},'time',this.value)"></td>
        </tr>
      `).join("")}`;
  } else if (activeSheet === 'advancement') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Source Group ID</th>
        <th style="width:90px;">Placement</th>
        <th style="width:120px;">Target Group ID</th>
        <th style="width:100px;">Team Count</th>
      </tr>
      ${advancement.map((r, i) => `
        <tr class="${selections.advancement===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.sourceGroupId)}" oninput="updateField(${i},'sourceGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.placement)}" oninput="updateField(${i},'placement',this.value)"></td>
          <td class="num"><input value="${safe(r.targetGroupId)}" oninput="updateField(${i},'targetGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.teamCount)}" oninput="updateField(${i},'teamCount',this.value)"></td>
        </tr>
      `).join("")}`;
  } else if (activeSheet === 'standings') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Group ID</th>
        <th style="width:110px;">Slot Number</th>
      </tr>
      ${standings.map((r, i) => `
        <tr class="${selections.standings===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.groupId)}" oninput="updateField(${i},'groupId',this.value)"></td>
          <td class="num"><input value="${safe(r.slotNumber)}" oninput="updateField(${i},'slotNumber',this.value)"></td>
        </tr>
      `).join("")}`;
  } else if (activeSheet === 'tasks') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:120px;">Trophy ID</th>
        <th style="width:90px;">Task Phase</th>
        <th style="width:150px;">Task Type</th>
        <th style="width:120px;">Target ID</th>
        <th style="width:120px;">Reference ID</th>
        <th style="width:80px;">Arg1</th>
        <th style="width:80px;">Arg2</th>
      </tr>
      ${tasks.map((r, i) => {
        const highlight = taskHighlightMap.get(i);
        const columns = highlight ? highlight.columns : null;
        const trophyClass = columns && columns.has('trophyId') ? 'highlight-auto' : '';
        const targetClass = columns && columns.has('targetId') ? 'highlight-auto' : '';
        const refClass = columns && columns.has('refId') ? 'highlight-auto' : '';
        return `
        <tr class="${selections.tasks===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num ${trophyClass}"><input value="${safe(r.trophyId)}" oninput="updateField(${i},'trophyId',this.value)"></td>
          <td><input value="${safe(r.phase)}" oninput="updateField(${i},'phase',this.value)"></td>
          <td><input value="${safe(r.taskType)}" oninput="updateField(${i},'taskType',this.value)"></td>
          <td class="num ${targetClass}"><input value="${safe(r.targetId)}" oninput="updateField(${i},'targetId',this.value)"></td>
          <td class="num ${refClass}"><input value="${safe(r.refId)}" oninput="updateField(${i},'refId',this.value)"></td>
          <td class="num"><input value="${safe(r.arg1)}" oninput="updateField(${i},'arg1',this.value)"></td>
          <td class="num"><input value="${safe(r.arg2)}" oninput="updateField(${i},'arg2',this.value)"></td>
        </tr>`;
      }).join("")}`;
  } else if (activeSheet === 'weather') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Nation ID</th>
        <th style="width:70px;">Entry</th>
        <th style="width:80px;">Temp</th>
        <th style="width:80px;">Cloud</th>
        <th style="width:80px;">Rain</th>
        <th style="width:80px;">Snow</th>
        <th style="width:80px;">Wind</th>
        <th style="width:90px;">Start</th>
        <th style="width:90px;">End</th>
      </tr>
      ${weather.map((r, i) => `
        <tr class="${selections.weather===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.nationId)}" oninput="updateField(${i},'nationId',this.value)"></td>
          <td class="num"><input value="${safe(r.entry)}" oninput="updateField(${i},'entry',this.value)"></td>
          <td class="num"><input value="${safe(r.temp)}" oninput="updateField(${i},'temp',this.value)"></td>
          <td class="num"><input value="${safe(r.cloud)}" oninput="updateField(${i},'cloud',this.value)"></td>
          <td class="num"><input value="${safe(r.rain)}" oninput="updateField(${i},'rain',this.value)"></td>
          <td class="num"><input value="${safe(r.snow)}" oninput="updateField(${i},'snow',this.value)"></td>
          <td class="num"><input value="${safe(r.wind)}" oninput="updateField(${i},'wind',this.value)"></td>
          <td class="num"><input value="${safe(r.start)}" oninput="updateField(${i},'start',this.value)"></td>
          <td class="num"><input value="${safe(r.end)}" oninput="updateField(${i},'end',this.value)"></td>
        </tr>
      `).join("")}`;
  } else {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Stage/Group ID</th>
        <th>Setting Key</th>
        <th>Setting Value</th>
      </tr>
      ${settings.map((r, i) => `
        <tr class="${selections.settings===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.stageGroupId)}" oninput="updateField(${i},'stageGroupId',this.value)"></td>
          <td><input value="${safe(r.key)}" oninput="updateField(${i},'key',this.value)"></td>
          <td><input value="${safe(r.value)}" oninput="updateField(${i},'value',this.value)"></td>
        </tr>
      `).join("")}`;
  }
}

function setActiveSheet(sheet) {
  if (sheet === activeSheet) return;
  activeSheet = sheet;
  render();
}

function selectRow(i) {
  selections[activeSheet] = i;
  render();
}

function getDataArray(sheet) {
  if (sheet === 'compobj') return compobj;
  if (sheet === 'schedule') return schedule;
  if (sheet === 'advancement') return advancement;
  if (sheet === 'standings') return standings;
  if (sheet === 'tasks') return tasks;
  if (sheet === 'weather') return weather;
  return settings;
}

function updateField(i, field, value) {
  const target = getDataArray(activeSheet);
  if (!target[i]) return;
  const previousValue = target[i][field];
  target[i][field] = value;
  if (activeSheet === 'compobj' && field === 'id') {
    syncReferencesForManualIdChange(previousValue, value);
  }
}

function getSelectedIndex(sheet = activeSheet) {
  return selections[sheet];
}

function defaultRowForSheet(sheet) {
  if (sheet === 'compobj') {
    return createDefaultCompobjRow();
  }
  if (sheet === 'schedule') {
    return { stageGroupId: '', dayId: '', matchday: '', minMatches: '', maxMatches: '', time: '' };
  }
  if (sheet === 'advancement') {
    return { sourceGroupId: '', placement: '', targetGroupId: '', teamCount: '' };
  }
  if (sheet === 'standings') {
    return { groupId: '', slotNumber: '' };
  }
  if (sheet === 'tasks') {
    return { trophyId: '', phase: '', taskType: '', targetId: '', refId: '', arg1: '', arg2: '' };
  }
  if (sheet === 'weather') {
    return { nationId: '', entry: '', temp: '', cloud: '', rain: '', snow: '', wind: '', start: '', end: '' };
  }
  return { stageGroupId: '', key: '', value: '' };
}

function addRow(sheet = activeSheet) {
  if (sheet === 'compobj') {
    compobj.push(createDefaultCompobjRow());
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    schedule.push(defaultRowForSheet(sheet));
  } else if (sheet === 'advancement') {
    advancement.push(defaultRowForSheet(sheet));
  } else if (sheet === 'standings') {
    standings.push(defaultRowForSheet(sheet));
  } else if (sheet === 'tasks') {
    clearTaskHighlights();
    tasks.push(defaultRowForSheet(sheet));
  } else if (sheet === 'weather') {
    weather.push(defaultRowForSheet(sheet));
  } else {
    settings.push(defaultRowForSheet(sheet));
  }
  render();
}

function triggerFileDialog(sheet, type) {
  const input = document.getElementById(`fileInput-${sheet}-${type}`);
  input.value = '';
  input.click();
}

function insertRows(sheet, position) {
  const selected = getSelectedIndex(sheet);
  if (selected === null) return alert('Select a row first.');
  const insertInput = document.getElementById(`insertCount-${sheet}`);
  const count = parseInt(insertInput.value, 10) || 1;
  const newRows = Array.from({ length: count }, () => ({ ...defaultRowForSheet(sheet) }));

  if (sheet === 'compobj') {
    const index = position === 'above' ? selected : selected + 1;
    compobj.splice(index, 0, ...newRows);
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    const index = position === 'above' ? selected : selected + 1;
    schedule.splice(index, 0, ...newRows);
  } else if (sheet === 'advancement') {
    const index = position === 'above' ? selected : selected + 1;
    advancement.splice(index, 0, ...newRows);
  } else if (sheet === 'standings') {
    const index = position === 'above' ? selected : selected + 1;
    standings.splice(index, 0, ...newRows);
  } else if (sheet === 'tasks') {
    clearTaskHighlights();
    const index = position === 'above' ? selected : selected + 1;
    tasks.splice(index, 0, ...newRows);
  } else if (sheet === 'weather') {
    const index = position === 'above' ? selected : selected + 1;
    weather.splice(index, 0, ...newRows);
  } else {
    const index = position === 'above' ? selected : selected + 1;
    settings.splice(index, 0, ...newRows);
  }
  render();
}

function deleteRow(sheet = activeSheet) {
  const selected = getSelectedIndex(sheet);
  if (selected === null) return alert('Select a row first.');
  if (sheet === 'compobj') {
    compobj.splice(selected, 1);
    selections.compobj = null;
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    schedule.splice(selected, 1);
    selections.schedule = null;
  } else if (sheet === 'advancement') {
    advancement.splice(selected, 1);
    selections.advancement = null;
  } else if (sheet === 'standings') {
    standings.splice(selected, 1);
    selections.standings = null;
  } else if (sheet === 'tasks') {
    clearTaskHighlights();
    tasks.splice(selected, 1);
    selections.tasks = null;
  } else if (sheet === 'weather') {
    weather.splice(selected, 1);
    selections.weather = null;
  } else {
    settings.splice(selected, 1);
    selections.settings = null;
  }
  render();
}

function exportTxt(sheet = activeSheet) {
  const activeData = getDataArray(sheet);
  let lines = '';
  let filename = '';
  if (sheet === 'compobj') {
    lines = activeData.map(r => `${r.id},${r.depth},${r.code},${r.name},${r.parentDisplay}`).join('\n');
    filename = 'compobj.txt';
  } else if (sheet === 'schedule') {
    lines = activeData.map(r => `${r.stageGroupId},${r.dayId},${r.matchday},${r.minMatches},${r.maxMatches},${r.time}`).join('\n');
    filename = 'schedule.txt';
  } else if (sheet === 'advancement') {
    lines = activeData.map(r => `${r.sourceGroupId},${r.placement},${r.targetGroupId},${r.teamCount}`).join('\n');
    filename = 'advancement.txt';
  } else if (sheet === 'standings') {
    lines = activeData.map(r => `${r.groupId},${r.slotNumber}`).join('\n');
    filename = 'standings.txt';
  } else if (sheet === 'weather') {
    lines = activeData.map(r => `${r.nationId},${r.entry},${r.temp},${r.cloud},${r.rain},${r.snow},${r.wind},${r.start},${r.end}`).join('\n');
    filename = 'weather.txt';
  } else if (sheet === 'tasks') {
    lines = activeData.map(r => `${r.trophyId},${r.phase},${r.taskType},${r.targetId},${r.refId},${r.arg1},${r.arg2}`).join('\n');
    filename = 'tasks.txt';
  } else {
    lines = activeData.map(r => `${r.stageGroupId},${r.key},${r.value}`).join('\n');
    filename = 'settings.txt';
  }
  const blob = new Blob([lines], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function importFile(e, append = false, sheetOverride = null) {
  const f = e.target.files[0];
  const sheetTarget = sheetOverride || e.target.dataset.sheet || activeSheet;
  if (!f) return;
  const r = new FileReader();
  r.onload = function (ev) {
    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim() !== '');
    if (sheetTarget === 'compobj') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          id: p[0] || '',
          depth: p[1] || '',
          code: p[2] || '',
          name: p[3] || '',
          parentDisplay: p[4] || ''
        };
      });
      compobj = append ? [...compobj, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
      renumberCompobjIds();
    } else if (sheetTarget === 'schedule') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          stageGroupId: p[0] || '',
          dayId: p[1] || '',
          matchday: p[2] || '',
          minMatches: p[3] || '',
          maxMatches: p[4] || '',
          time: p[5] || ''
        };
      });
      schedule = append ? [...schedule, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else if (sheetTarget === 'advancement') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          sourceGroupId: p[0] || '',
          placement: p[1] || '',
          targetGroupId: p[2] || '',
          teamCount: p[3] || ''
        };
      });
      advancement = append ? [...advancement, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else if (sheetTarget === 'standings') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          groupId: p[0] || '',
          slotNumber: p[1] || ''
        };
      });
      standings = append ? [...standings, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else if (sheetTarget === 'weather') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          nationId: p[0] || '',
          entry: p[1] || '',
          temp: p[2] || '',
          cloud: p[3] || '',
          rain: p[4] || '',
          snow: p[5] || '',
          wind: p[6] || '',
          start: p[7] || '',
          end: p[8] || ''
        };
      });
      weather = append ? [...weather, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else if (sheetTarget === 'tasks') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          trophyId: p[0] || '',
          phase: p[1] || '',
          taskType: p[2] || '',
          targetId: p[3] || '',
          refId: p[4] || '',
          arg1: p[5] || '',
          arg2: p[6] || ''
        };
      });
      clearTaskHighlights();
      tasks = append ? [...tasks, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          stageGroupId: p[0] || '',
          key: p[1] || '',
          value: p.slice(2).join(',') || ''
        };
      });
      settings = append ? [...settings, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    }
    render();
  };
  r.readAsText(f);
}

function updateControlVisibility() {
  document.querySelectorAll('#controls .control-set').forEach((el) => {
    el.classList.toggle('active', el.dataset.sheetControls === activeSheet);
  });
}

/* Example demo data */
compobj = [
  { id: 0, depth: 0, code: "FIFA", name: "FIFA", parentDisplay: "-1" },
  { id: 1, depth: 3, code: "C990", name: "TrophyName_Abbr15_990", parentDisplay: "0" },
  { id: 2, depth: 4, code: "S1", name: "FCE_Setup_Stage", parentDisplay: "1" },
  { id: 3, depth: 5, code: "G1", name: "", parentDisplay: "2" },
  { id: 4, depth: 5, code: "G2", name: "", parentDisplay: "2" },
  { id: 5, depth: 4, code: "S2", name: "FCE_Group_Stage", parentDisplay: "1" },
  { id: 6, depth: 5, code: "G1", name: "FCE_Group_A", parentDisplay: "5" },
  { id: 7, depth: 5, code: "G2", name: "FCE_Group_B", parentDisplay: "5" },
  { id: 8, depth: 4, code: "S3", name: "FCE_Final", parentDisplay: "1" }
];

schedule = [
  { stageGroupId: '2', dayId: '257', matchday: '1', minMatches: '1', maxMatches: '1', time: '1400' },
  { stageGroupId: '5', dayId: '258', matchday: '2', minMatches: '2', maxMatches: '4', time: '1600' }
];

advancement = [
  { sourceGroupId: '1628', placement: '3', targetGroupId: '1630', teamCount: '1' },
  { sourceGroupId: '1628', placement: '6', targetGroupId: '1630', teamCount: '2' },
  { sourceGroupId: '1628', placement: '4', targetGroupId: '1631', teamCount: '1' },
  { sourceGroupId: '1628', placement: '5', targetGroupId: '1631', teamCount: '2' },
  { sourceGroupId: '1630', placement: '1', targetGroupId: '1633', teamCount: '1' },
  { sourceGroupId: '1628', placement: '1', targetGroupId: '1633', teamCount: '2' },
  { sourceGroupId: '1631', placement: '1', targetGroupId: '1634', teamCount: '1' },
  { sourceGroupId: '1628', placement: '2', targetGroupId: '1634', teamCount: '2' },
  { sourceGroupId: '1633', placement: '1', targetGroupId: '1636', teamCount: '1' },
  { sourceGroupId: '1634', placement: '1', targetGroupId: '1636', teamCount: '2' }
];

standings = [
  { groupId: '1628', slotNumber: '0' },
  { groupId: '1628', slotNumber: '1' },
  { groupId: '1628', slotNumber: '2' },
  { groupId: '1628', slotNumber: '3' },
  { groupId: '1628', slotNumber: '4' },
  { groupId: '1628', slotNumber: '5' },
  { groupId: '1628', slotNumber: '6' },
  { groupId: '1628', slotNumber: '7' },
  { groupId: '1628', slotNumber: '8' },
  { groupId: '1628', slotNumber: '9' },
  { groupId: '1628', slotNumber: '10' },
  { groupId: '1628', slotNumber: '11' },
  { groupId: '1628', slotNumber: '12' },
  { groupId: '1628', slotNumber: '13' },
  { groupId: '1630', slotNumber: '0' },
  { groupId: '1630', slotNumber: '1' },
  { groupId: '1631', slotNumber: '0' },
  { groupId: '1631', slotNumber: '1' },
  { groupId: '1633', slotNumber: '0' },
  { groupId: '1633', slotNumber: '1' },
  { groupId: '1634', slotNumber: '0' },
  { groupId: '1634', slotNumber: '1' },
  { groupId: '1636', slotNumber: '0' },
  { groupId: '1636', slotNumber: '1' }
];

settings = [
  { stageGroupId: '1625', key: 'nation_id', value: '159' },
  { stageGroupId: '1625', key: 'rule_suspension', value: '1625' },
  { stageGroupId: '1625', key: 'schedule_seasonstartmonth', value: 'JUL' },
  { stageGroupId: '1626', key: 'asset_id', value: '2149' },
  { stageGroupId: '1626', key: 'comp_type', value: 'LEAGUE' },
  { stageGroupId: '1626', key: 'rule_numyellowstored', value: '4' },
  { stageGroupId: '1627', key: 'match_matchsituation', value: 'LEAGUE' },
  { stageGroupId: '1628', key: 'num_games', value: '2' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '1' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '2' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '3' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '4' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '5' },
  { stageGroupId: '1628', key: 'info_label_slot_adv_group', value: '6' },
  { stageGroupId: '1629', key: 'match_matchsituation', value: 'ROUNDX' },
  { stageGroupId: '1629', key: 'match_stagetype', value: 'KO1LEG' },
  { stageGroupId: '1629', key: 'info_prize_money', value: '84920' },
  { stageGroupId: '1629', key: 'info_prize_money_drop', value: '100' },
  { stageGroupId: '1630', key: 'num_games', value: '1' },
  { stageGroupId: '1631', key: 'num_games', value: '1' },
  { stageGroupId: '1632', key: 'match_stagetype', value: 'KO2LEGS' },
  { stageGroupId: '1632', key: 'match_matchsituation', value: 'SEMI' },
  { stageGroupId: '1632', key: 'info_prize_money', value: '169845' },
  { stageGroupId: '1632', key: 'info_prize_money_drop', value: '100' },
  { stageGroupId: '1633', key: 'num_games', value: '2' },
  { stageGroupId: '1634', key: 'num_games', value: '2' },
  { stageGroupId: '1635', key: 'match_stagetype', value: 'KO1LEG' },
  { stageGroupId: '1635', key: 'match_matchsituation', value: 'FINAL' },
  { stageGroupId: '1635', key: 'info_prize_money', value: '905840' },
  { stageGroupId: '1635', key: 'info_prize_money_drop', value: '50' },
  { stageGroupId: '1636', key: 'num_games', value: '1' },
  { stageGroupId: '1636', key: 'info_slot_champ', value: '1' }
];

tasks = [
  { trophyId: '1626', phase: 'start', taskType: 'ClearLeagueStats', targetId: '1627', refId: '2149', arg1: '0', arg2: '0' },
  { trophyId: '1626', phase: 'end', taskType: 'UpdateTable', targetId: '1626', refId: '1636', arg1: '1', arg2: '1' },
  { trophyId: '1626', phase: 'end', taskType: 'UpdateTable', targetId: '1626', refId: '1628', arg1: '2', arg2: '2' },
  { trophyId: '1626', phase: 'end', taskType: 'UpdateTable', targetId: '1626', refId: '1628', arg1: '3', arg2: '3' },
  { trophyId: '1626', phase: 'end', taskType: 'UpdateLeagueStats', targetId: '1627', refId: '2149', arg1: '0', arg2: '0' }
];

weather = [
  { nationId: '1777', entry: '1', temp: '65', cloud: '15', rain: '10', snow: '0', wind: '10', start: '2345', end: '45' },
  { nationId: '1777', entry: '2', temp: '60', cloud: '25', rain: '10', snow: '0', wind: '5', start: '2315', end: '15' },
  { nationId: '1777', entry: '3', temp: '60', cloud: '25', rain: '10', snow: '0', wind: '5', start: '2245', end: '2345' },
  { nationId: '1777', entry: '4', temp: '55', cloud: '20', rain: '15', snow: '0', wind: '10', start: '2200', end: '2300' },
  { nationId: '1777', entry: '5', temp: '45', cloud: '10', rain: '15', snow: '0', wind: '30', start: '2130', end: '2230' },
  { nationId: '1777', entry: '6', temp: '45', cloud: '5', rain: '20', snow: '0', wind: '30', start: '2115', end: '2215' },
  { nationId: '1777', entry: '7', temp: '35', cloud: '15', rain: '10', snow: '0', wind: '40', start: '2130', end: '2230' },
  { nationId: '1777', entry: '8', temp: '40', cloud: '15', rain: '20', snow: '0', wind: '25', start: '2145', end: '2245' },
  { nationId: '1777', entry: '9', temp: '55', cloud: '10', rain: '25', snow: '0', wind: '10', start: '2215', end: '2300' },
  { nationId: '1777', entry: '10', temp: '55', cloud: '25', rain: '10', snow: '0', wind: '10', start: '2230', end: '2330' },
  { nationId: '1777', entry: '11', temp: '65', cloud: '15', rain: '10', snow: '0', wind: '10', start: '2300', end: '15' },
  { nationId: '1777', entry: '12', temp: '80', cloud: '5', rain: '10', snow: '0', wind: '5', start: '2330', end: '45' }
];

renumberCompobjIds();
render();
</script>

</body>
</html>
