<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CompObj Compact Editor</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    font-size: 12px;
    color: #222;
    background: #f5f6f8;
    margin: 0;
    padding: 20px;
  }

  #container {
    max-width: 1200px;
    margin: auto;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    padding: 12px;
  }

  #sheet-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }

  #sheet-tabs button {
    flex: 0 0 auto;
    border-radius: 6px 6px 0 0;
    border-bottom: none;
    padding: 6px 14px;
    font-weight: 600;
    background: #e9eef5;
  }

  #sheet-tabs button.active {
    background: #fff;
    border-color: #c5d3e3;
    border-bottom: 1px solid #fff;
  }

  #controls {
    border: 1px solid #e3e7ef;
    border-top: none;
    border-radius: 0 6px 6px 6px;
    background: #fff;
    margin-bottom: 10px;
  }

  #controls .control-set {
    display: none;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    padding: 8px;
  }

  #controls .control-set.active {
    display: flex;
  }

  button {
    font-size: 12px;
    border: 1px solid #ccc;
    background: #fff;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    transition: 0.1s;
  }
  button:hover { background: #f2f2f2; }

  input[type="number"] {
    width: 45px;
    font-size: 12px;
    padding: 2px 4px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }

  input[type="file"] { display: none; }

  #lineCount {
    font-size: 12px;
    color: #666;
    margin-bottom: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  th, td {
    border: 1px solid #eee;
    padding: 3px 6px;
    height: 24px;
    text-align: left;
    background: #fff;
  }

  th {
    background: #f9fafb;
    font-weight: 600;
    font-size: 12px;
    color: #555;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  td input {
    width: 100%;
    border: none;
    outline: none;
    font: inherit;
    background: transparent;
    padding: 2px 3px;
    height: 20px;
    color: #222;
  }

  td.num input { text-align: center; color: #333; }

  /* Colored side tags */
  tr.stage td:first-child { border-left: 3px solid #90c4ff; }
  tr.group td:first-child { border-left: 3px solid #ffb870; }
  tr.final td:first-child { border-left: 3px solid #bba7ff; }
  tr.schedule-row td:first-child { border-left: 3px solid #86d4ff; }

  tr:hover td { background: #f5faff; }
  tr.selected td { background: #e9f3ff !important; outline: 1px solid #0078d7; }

  #sheet tr:nth-child(even) td { background: #fdf7ef; }

  #table-wrapper {
    height: 85vh;
    overflow-y: auto;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
  }
</style>
</head>
<body>

  <div id="container">
    <div id="sheet-tabs">
      <button id="tab-compobj" class="active" onclick="setActiveSheet('compobj')">üß© CompObj</button>
      <button id="tab-schedule" onclick="setActiveSheet('schedule')">üìÖ Schedule</button>
      <button id="tab-advancement" onclick="setActiveSheet('advancement')">üèÜ Advancement</button>
    </div>
    <div id="controls">
      <div class="control-set active" data-sheet-controls="compobj">
        <button onclick="triggerFileDialog('compobj','import')">üìÇ Import .txt</button>
        <input type="file" id="fileInput-compobj-import" accept=".txt,.csv" onchange="importFile(event,false,'compobj')">
        <button onclick="triggerFileDialog('compobj','append')">‚ûï Append .txt</button>
        <input type="file" id="fileInput-compobj-append" accept=".txt,.csv" onchange="importFile(event,true,'compobj')">
        <button onclick="addRow('compobj')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-compobj" min="1" value="1">
        <button onclick="insertRows('compobj','above')">‚Üë Insert Above</button>
        <button onclick="insertRows('compobj','below')">‚Üì Insert Below</button>
        <button onclick="deleteRow('compobj')">‚àí Delete Selected</button>
        <button onclick="exportTxt('compobj')">üíæ Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="schedule">
        <button onclick="triggerFileDialog('schedule','import')">üìÇ Import .txt</button>
        <input type="file" id="fileInput-schedule-import" accept=".txt,.csv" onchange="importFile(event,false,'schedule')">
        <button onclick="triggerFileDialog('schedule','append')">‚ûï Append .txt</button>
        <input type="file" id="fileInput-schedule-append" accept=".txt,.csv" onchange="importFile(event,true,'schedule')">
        <button onclick="addRow('schedule')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-schedule" min="1" value="1">
        <button onclick="insertRows('schedule','above')">‚Üë Insert Above</button>
        <button onclick="insertRows('schedule','below')">‚Üì Insert Below</button>
        <button onclick="deleteRow('schedule')">‚àí Delete Selected</button>
        <button onclick="exportTxt('schedule')">üíæ Export .txt</button>
      </div>
      <div class="control-set" data-sheet-controls="advancement">
        <button onclick="triggerFileDialog('advancement','import')">üìÇ Import .txt</button>
        <input type="file" id="fileInput-advancement-import" accept=".txt,.csv" onchange="importFile(event,false,'advancement')">
        <button onclick="triggerFileDialog('advancement','append')">‚ûï Append .txt</button>
        <input type="file" id="fileInput-advancement-append" accept=".txt,.csv" onchange="importFile(event,true,'advancement')">
        <button onclick="addRow('advancement')">+ Add Row (End)</button>
        <span>| Insert:</span>
        <input type="number" id="insertCount-advancement" min="1" value="1">
        <button onclick="insertRows('advancement','above')">‚Üë Insert Above</button>
        <button onclick="insertRows('advancement','below')">‚Üì Insert Below</button>
        <button onclick="deleteRow('advancement')">‚àí Delete Selected</button>
        <button onclick="exportTxt('advancement')">üíæ Export .txt</button>
      </div>
    </div>

  <div id="lineCount"></div>

  <div id="table-wrapper">
    <table id="sheet"></table>
  </div>
</div>

<script>
let compobj = [];
let schedule = [];
let advancement = [];
let activeSheet = 'compobj';
const selections = { compobj: null, schedule: null, advancement: null };
let tempIdCounter = 0;

function safe(value) {
  return (value ?? '').toString()
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function getRowClass(r) {
  if (!r.code && !r.name) return "";
  const code = (r.code || "").toUpperCase();
  const name = (r.name || "").toUpperCase();
  if (code.startsWith("S")) return "stage";
  if (code.startsWith("G")) return "group";
  if (name.includes("FINAL") || name.includes("PLAYOFF")) return "final";
  return "";
}

function createDefaultCompobjRow() {
  return { id: `__temp-${tempIdCounter++}`, depth: 5, code: '', name: '', parentDisplay: '' };
}

function renumberCompobjIds() {
  const idMap = new Map();

  compobj.forEach((row, index) => {
    const oldId = row.id == null ? '' : String(row.id);
    const newId = String(index);
    if (oldId !== '') {
      idMap.set(oldId, newId);
    }
    row.id = newId;
  });

  compobj.forEach((row) => {
    const parent = row.parentDisplay == null ? '' : String(row.parentDisplay);
    if (parent === '') return;
    const mapped = idMap.get(parent);
    if (mapped !== undefined) {
      row.parentDisplay = mapped;
    }
  });

  schedule = schedule.map((row) => {
    const current = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (current === '') return row;
    const mapped = idMap.get(current);
    if (mapped === undefined) return row;
    return { ...row, stageGroupId: mapped };
  });

  advancement = advancement.map((row) => {
    const source = row.sourceGroupId == null ? '' : String(row.sourceGroupId);
    const target = row.targetGroupId == null ? '' : String(row.targetGroupId);
    const mappedSource = source !== '' ? idMap.get(source) : undefined;
    const mappedTarget = target !== '' ? idMap.get(target) : undefined;
    if (mappedSource === undefined && mappedTarget === undefined) return row;
    return {
      ...row,
      sourceGroupId: mappedSource !== undefined ? mappedSource : row.sourceGroupId,
      targetGroupId: mappedTarget !== undefined ? mappedTarget : row.targetGroupId
    };
  });
}

function syncReferencesForManualIdChange(oldValue, newValue) {
  const previous = oldValue == null ? '' : String(oldValue);
  const next = newValue == null ? '' : String(newValue);
  if (previous === next) return;

  compobj.forEach((row) => {
    const parent = row.parentDisplay == null ? '' : String(row.parentDisplay);
    if (parent === previous) {
      row.parentDisplay = next;
    }
  });

  schedule = schedule.map((row) => {
    const current = row.stageGroupId == null ? '' : String(row.stageGroupId);
    if (current !== previous) return row;
    return { ...row, stageGroupId: next };
  });

  advancement = advancement.map((row) => {
    const source = row.sourceGroupId == null ? '' : String(row.sourceGroupId);
    const target = row.targetGroupId == null ? '' : String(row.targetGroupId);
    let changed = false;
    let newSource = row.sourceGroupId;
    let newTarget = row.targetGroupId;
    if (source === previous) {
      newSource = next;
      changed = true;
    }
    if (target === previous) {
      newTarget = next;
      changed = true;
    }
    return changed ? { ...row, sourceGroupId: newSource, targetGroupId: newTarget } : row;
  });
}

function render() {
  const table = document.getElementById("sheet");
  const lineCount = document.getElementById("lineCount");
  document.getElementById('tab-compobj').classList.toggle('active', activeSheet === 'compobj');
  document.getElementById('tab-schedule').classList.toggle('active', activeSheet === 'schedule');
  document.getElementById('tab-advancement').classList.toggle('active', activeSheet === 'advancement');
  updateControlVisibility();

  const countLabel = activeSheet === 'compobj'
    ? `CompObj: ${compobj.length} lines parsed`
    : activeSheet === 'schedule'
      ? `Schedule: ${schedule.length} entries parsed`
      : `Advancement: ${advancement.length} links parsed`;
  lineCount.textContent = countLabel;

  if (activeSheet === 'compobj') {
    table.innerHTML = `
      <tr>
        <th style="width:32px;">#</th>
        <th style="width:70px;">ID</th>
        <th style="width:60px;">Level</th>
        <th style="width:80px;">Code</th>
        <th>Name</th>
        <th style="width:70px;">Parent</th>
      </tr>
      ${compobj.map((r, i) => `
        <tr class="${getRowClass(r)} ${selections.compobj===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.id)}" oninput="updateField(${i},'id',this.value)"></td>
          <td class="num"><input value="${safe(r.depth)}" oninput="updateField(${i},'depth',this.value)"></td>
          <td><input value="${safe(r.code)}" oninput="updateField(${i},'code',this.value)"></td>
          <td><input value="${safe(r.name)}" oninput="updateField(${i},'name',this.value)"></td>
          <td class="num"><input value="${safe(r.parentDisplay)}" oninput="updateField(${i},'parentDisplay',this.value)"></td>
        </tr>
      `).join("")}`;
  } else if (activeSheet === 'schedule') {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Stage/Group ID</th>
        <th style="width:80px;">Day ID</th>
        <th style="width:90px;">Matchday</th>
        <th style="width:100px;">Min Matches</th>
        <th style="width:100px;">Max Matches</th>
        <th style="width:80px;">Time</th>
      </tr>
      ${schedule.map((r, i) => `
        <tr class="schedule-row ${selections.schedule===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.stageGroupId)}" oninput="updateField(${i},'stageGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.dayId)}" oninput="updateField(${i},'dayId',this.value)"></td>
          <td class="num"><input value="${safe(r.matchday)}" oninput="updateField(${i},'matchday',this.value)"></td>
          <td class="num"><input value="${safe(r.minMatches)}" oninput="updateField(${i},'minMatches',this.value)"></td>
          <td class="num"><input value="${safe(r.maxMatches)}" oninput="updateField(${i},'maxMatches',this.value)"></td>
          <td class="num"><input value="${safe(r.time)}" oninput="updateField(${i},'time',this.value)"></td>
        </tr>
      `).join("")}`;
  } else {
    table.innerHTML = `
      <tr>
        <th style="width:40px;">#</th>
        <th style="width:110px;">Source Group ID</th>
        <th style="width:90px;">Placement</th>
        <th style="width:120px;">Target Group ID</th>
        <th style="width:100px;">Team Count</th>
      </tr>
      ${advancement.map((r, i) => `
        <tr class="${selections.advancement===i?'selected':''}" onclick="selectRow(${i})">
          <td class="num">${i+1}</td>
          <td class="num"><input value="${safe(r.sourceGroupId)}" oninput="updateField(${i},'sourceGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.placement)}" oninput="updateField(${i},'placement',this.value)"></td>
          <td class="num"><input value="${safe(r.targetGroupId)}" oninput="updateField(${i},'targetGroupId',this.value)"></td>
          <td class="num"><input value="${safe(r.teamCount)}" oninput="updateField(${i},'teamCount',this.value)"></td>
        </tr>
      `).join("")}`;
  }
}

function setActiveSheet(sheet) {
  if (sheet === activeSheet) return;
  activeSheet = sheet;
  render();
}

function selectRow(i) {
  selections[activeSheet] = i;
  render();
}

function getDataArray(sheet) {
  if (sheet === 'compobj') return compobj;
  if (sheet === 'schedule') return schedule;
  return advancement;
}

function updateField(i, field, value) {
  const target = getDataArray(activeSheet);
  if (!target[i]) return;
  const previousValue = target[i][field];
  target[i][field] = value;
  if (activeSheet === 'compobj' && field === 'id') {
    syncReferencesForManualIdChange(previousValue, value);
  }
}

function getSelectedIndex(sheet = activeSheet) {
  return selections[sheet];
}

function defaultRowForSheet(sheet) {
  if (sheet === 'compobj') {
    return createDefaultCompobjRow();
  }
  if (sheet === 'schedule') {
    return { stageGroupId: '', dayId: '', matchday: '', minMatches: '', maxMatches: '', time: '' };
  }
  return { sourceGroupId: '', placement: '', targetGroupId: '', teamCount: '' };
}

function addRow(sheet = activeSheet) {
  if (sheet === 'compobj') {
    compobj.push(createDefaultCompobjRow());
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    schedule.push(defaultRowForSheet(sheet));
  } else {
    advancement.push(defaultRowForSheet(sheet));
  }
  render();
}

function triggerFileDialog(sheet, type) {
  const input = document.getElementById(`fileInput-${sheet}-${type}`);
  input.value = '';
  input.click();
}

function insertRows(sheet, position) {
  const selected = getSelectedIndex(sheet);
  if (selected === null) return alert('Select a row first.');
  const insertInput = document.getElementById(`insertCount-${sheet}`);
  const count = parseInt(insertInput.value, 10) || 1;
  const newRows = Array.from({ length: count }, () => ({ ...defaultRowForSheet(sheet) }));

  if (sheet === 'compobj') {
    const index = position === 'above' ? selected : selected + 1;
    compobj.splice(index, 0, ...newRows);
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    const index = position === 'above' ? selected : selected + 1;
    schedule.splice(index, 0, ...newRows);
  } else {
    const index = position === 'above' ? selected : selected + 1;
    advancement.splice(index, 0, ...newRows);
  }
  render();
}

function deleteRow(sheet = activeSheet) {
  const selected = getSelectedIndex(sheet);
  if (selected === null) return alert('Select a row first.');
  if (sheet === 'compobj') {
    compobj.splice(selected, 1);
    selections.compobj = null;
    renumberCompobjIds();
  } else if (sheet === 'schedule') {
    schedule.splice(selected, 1);
    selections.schedule = null;
  } else {
    advancement.splice(selected, 1);
    selections.advancement = null;
  }
  render();
}

function exportTxt(sheet = activeSheet) {
  const activeData = getDataArray(sheet);
  let lines = '';
  let filename = '';
  if (sheet === 'compobj') {
    lines = activeData.map(r => `${r.id},${r.depth},${r.code},${r.name},${r.parentDisplay}`).join('\n');
    filename = 'compobj.txt';
  } else if (sheet === 'schedule') {
    lines = activeData.map(r => `${r.stageGroupId},${r.dayId},${r.matchday},${r.minMatches},${r.maxMatches},${r.time}`).join('\n');
    filename = 'schedule.txt';
  } else {
    lines = activeData.map(r => `${r.sourceGroupId},${r.placement},${r.targetGroupId},${r.teamCount}`).join('\n');
    filename = 'advancement.txt';
  }
  const blob = new Blob([lines], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function importFile(e, append = false, sheetOverride = null) {
  const f = e.target.files[0];
  const sheetTarget = sheetOverride || e.target.dataset.sheet || activeSheet;
  if (!f) return;
  const r = new FileReader();
  r.onload = function (ev) {
    const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim() !== '');
    if (sheetTarget === 'compobj') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          id: p[0] || '',
          depth: p[1] || '',
          code: p[2] || '',
          name: p[3] || '',
          parentDisplay: p[4] || ''
        };
      });
      compobj = append ? [...compobj, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
      renumberCompobjIds();
    } else if (sheetTarget === 'schedule') {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          stageGroupId: p[0] || '',
          dayId: p[1] || '',
          matchday: p[2] || '',
          minMatches: p[3] || '',
          maxMatches: p[4] || '',
          time: p[5] || ''
        };
      });
      schedule = append ? [...schedule, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    } else {
      const parsed = lines.map(l => {
        const p = l.split(/\t|,/);
        return {
          sourceGroupId: p[0] || '',
          placement: p[1] || '',
          targetGroupId: p[2] || '',
          teamCount: p[3] || ''
        };
      });
      advancement = append ? [...advancement, ...parsed] : parsed;
      if (activeSheet !== sheetTarget) setActiveSheet(sheetTarget);
    }
    render();
  };
  r.readAsText(f);
}

function updateControlVisibility() {
  document.querySelectorAll('#controls .control-set').forEach((el) => {
    el.classList.toggle('active', el.dataset.sheetControls === activeSheet);
  });
}

/* Example demo data */
compobj = [
  { id: 0, depth: 0, code: "FIFA", name: "FIFA", parentDisplay: "-1" },
  { id: 1, depth: 3, code: "C990", name: "TrophyName_Abbr15_990", parentDisplay: "0" },
  { id: 2, depth: 4, code: "S1", name: "FCE_Setup_Stage", parentDisplay: "1" },
  { id: 3, depth: 5, code: "G1", name: "", parentDisplay: "2" },
  { id: 4, depth: 5, code: "G2", name: "", parentDisplay: "2" },
  { id: 5, depth: 4, code: "S2", name: "FCE_Group_Stage", parentDisplay: "1" },
  { id: 6, depth: 5, code: "G1", name: "FCE_Group_A", parentDisplay: "5" },
  { id: 7, depth: 5, code: "G2", name: "FCE_Group_B", parentDisplay: "5" },
  { id: 8, depth: 4, code: "S3", name: "FCE_Final", parentDisplay: "1" }
];

schedule = [
  { stageGroupId: '2', dayId: '257', matchday: '1', minMatches: '1', maxMatches: '1', time: '1400' },
  { stageGroupId: '5', dayId: '258', matchday: '2', minMatches: '2', maxMatches: '4', time: '1600' }
];

advancement = [
  { sourceGroupId: '1628', placement: '3', targetGroupId: '1630', teamCount: '1' },
  { sourceGroupId: '1628', placement: '6', targetGroupId: '1630', teamCount: '2' },
  { sourceGroupId: '1628', placement: '4', targetGroupId: '1631', teamCount: '1' },
  { sourceGroupId: '1628', placement: '5', targetGroupId: '1631', teamCount: '2' },
  { sourceGroupId: '1630', placement: '1', targetGroupId: '1633', teamCount: '1' },
  { sourceGroupId: '1628', placement: '1', targetGroupId: '1633', teamCount: '2' },
  { sourceGroupId: '1631', placement: '1', targetGroupId: '1634', teamCount: '1' },
  { sourceGroupId: '1628', placement: '2', targetGroupId: '1634', teamCount: '2' },
  { sourceGroupId: '1633', placement: '1', targetGroupId: '1636', teamCount: '1' },
  { sourceGroupId: '1634', placement: '1', targetGroupId: '1636', teamCount: '2' }
];

renumberCompobjIds();
render();
</script>

</body>
</html>
