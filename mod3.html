<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CompObj + Advancement Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    .row-dirty { outline: 2px dashed rgb(251 191 36 / 0.7); }
    .sticky-th { position: sticky; top: 0; z-index: 10; }
  </style>
</head>
<body class="bg-slate-100 text-slate-900 p-6">
  <div class="max-w-6xl mx-auto">

    <!-- Header -->
    <header class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold">CompObj & Advancement Editor</h1>
        <p class="text-sm text-slate-600">
          Manage competition structures (CompObj) and advancement mapping lines in one tool.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <label class="text-sm">Theme</label>
        <select id="themeSelect" class="p-2 rounded border bg-white">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </header>

    <!-- ===================== -->
    <!-- CompObj Editor -->
    <!-- ===================== -->
    <section class="mb-10">
      <h2 class="text-xl font-bold mb-2">CompObj Editor</h2>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="fileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="pasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="exportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
        <button id="rebaseBtn" class="px-3 py-2 bg-amber-500 text-white rounded">Rebase IDs</button>
        <button id="autoFixBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Auto-Fix Parents</button>
        <button id="dedupeBtn" class="px-3 py-2 bg-fuchsia-600 text-white rounded">De-duplicate IDs</button>
      </div>

      <div class="mb-3 flex flex-wrap items-center gap-3">
        <label class="text-sm">Rebase start ID:</label>
        <input id="rebaseStart" type="number" value="1000" class="p-2 rounded border w-24 bg-white">
        <label class="text-sm">Delimiter:</label>
        <select id="delimiter" class="p-2 rounded border bg-white">
          <option value=",">Comma</option>
          <option value="\t">Tab</option>
          <option value=";">Semicolon</option>
          <option value="|">Pipe</option>
          <option value="auto" selected>Auto-detect</option>
        </select>
      </div>

      <textarea id="pasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste CompObj lines here..."></textarea>
      <div id="meta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table id="dataTable" class="min-w-full table-auto text-sm">
          <thead>
            <tr class="bg-slate-50 sticky-th">
              <th class="p-2">#</th>
              <th class="p-2">ID</th>
              <th class="p-2">Level</th>
              <th class="p-2">Code</th>
              <th class="p-2">Name</th>
              <th class="p-2">Parent</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="addLineBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Line</button>
        <button id="sortByIdBtn" class="px-3 py-2 bg-slate-500 text-white rounded">Sort by ID</button>
        <button id="validateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
      </div>

      <div id="messages" class="mt-3 text-sm"></div>
    </section>

    <!-- ===================== -->
    <!-- Advancement Editor -->
    <!-- ===================== -->
    <section id="advEditor">
      <h2 class="text-xl font-bold mb-2">Advancement Editor</h2>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="advFileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="advPasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="advExportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
      </div>

      <textarea id="advPasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste advancement lines here... (FromGroup,PlacementOrWinner,ToGroup,Slot)"></textarea>
      <div id="advMeta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table id="advTable" class="min-w-full table-auto text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">From Group ID</th>
              <th class="p-2">Placement / Winner</th>
              <th class="p-2">To Group ID</th>
              <th class="p-2">Slot #</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="advBody"></tbody>
        </table>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="advAddBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Line</button>
        <button id="advSortBtn" class="px-3 py-2 bg-slate-500 text-white rounded">Sort by From ID</button>
        <button id="advValidateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
      </div>

      <div id="advMessages" class="mt-3 text-sm"></div>
    </section>

    <!-- ===================== -->
    <!-- Standings Editor -->
    <!-- ===================== -->
    <section id="standingsEditor" class="mt-10">
      <h2 class="text-xl font-bold mb-2">Standings Editor</h2>
      <p class="text-sm text-slate-600 mb-3">
        Manage standings slot definitions such as <code>GroupId,ZeroBasedSlot</code>.
        Remember that slot <code>0</code> represents the first team in a table.
      </p>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="standingsFileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="standingsPasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="standingsExportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
      </div>

      <textarea id="standingsPasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste standings lines here... (GroupId,ZeroBasedSlot)"></textarea>
      <div id="standingsMeta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Group ID</th>
              <th class="p-2">Slot (0-index)</th>
              <th class="p-2">Team #</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="standingsBody"></tbody>
        </table>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="standingsAddBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Line</button>
        <button id="standingsSortBtn" class="px-3 py-2 bg-slate-500 text-white rounded">Sort by Group</button>
        <button id="standingsValidateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
      </div>

      <div id="standingsMessages" class="mt-3 text-sm"></div>
    </section>

    <!-- ===================== -->
    <!-- Settings Editor -->
    <!-- ===================== -->
    <section id="settingsEditor" class="mt-10">
      <h2 class="text-xl font-bold mb-2">Settings Editor</h2>
      <p class="text-sm text-slate-600 mb-3">
        Manage competition settings lines formatted as <code>CompObjID,SettingKey,SettingValue</code>.
        Each row links directly to a CompObj entry.
      </p>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="settingsFileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="settingsPasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="settingsExportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
        <button id="settingsValidateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
        <button id="settingsAddBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Row</button>
      </div>

      <textarea id="settingsPasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste settings lines here... (CompObjID,SettingKey,SettingValue)"></textarea>
      <div id="settingsMeta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">CompObj ID</th>
              <th class="p-2">Setting Key</th>
              <th class="p-2">Setting Value</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="settingsBody"></tbody>
        </table>
      </div>

      <div id="settingsMessages" class="mt-3 text-sm"></div>
    </section>

    <!-- ===================== -->
    <!-- Schedule Editor -->
    <!-- ===================== -->
    <section id="scheduleEditor" class="mt-10">
      <h2 class="text-xl font-bold mb-2">Schedule Editor</h2>
      <p class="text-sm text-slate-600 mb-3">
        Manage fixture schedule rows formatted as <code>StageID,DateID,RoundNumber,MinGames,MaxGames,Time</code>.
      </p>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="scheduleFileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="schedulePasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="scheduleExportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
        <button id="scheduleValidateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
        <button id="scheduleAddBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Row</button>
      </div>

      <textarea id="schedulePasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste schedule lines here... (StageID,DateID,RoundNumber,MinGames,MaxGames,Time)"></textarea>
      <div id="scheduleMeta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Stage ID</th>
              <th class="p-2">Date ID</th>
              <th class="p-2">Round #</th>
              <th class="p-2">Min Games</th>
              <th class="p-2">Max Games</th>
              <th class="p-2">Time</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="scheduleBody"></tbody>
        </table>
      </div>

      <div id="scheduleMessages" class="mt-3 text-sm"></div>
    </section>

    <!-- ===================== -->
    <!-- Tasks Editor -->
    <!-- ===================== -->
    <section id="taskEditor" class="mt-10">
      <h2 class="text-xl font-bold mb-2">Tasks Editor</h2>
      <p class="text-sm text-slate-600 mb-3">
        Manage competition task lines such as <code>FillFromLeague</code>, <code>FillWithTeam</code>, and <code>UpdateTable</code>.
      </p>

      <div class="mb-3 flex flex-wrap items-center gap-2">
        <input id="taskFileInput" type="file" accept=".txt" class="p-2 bg-white rounded border">
        <button id="taskPasteBtn" class="px-3 py-2 bg-indigo-600 text-white rounded">Paste/Text</button>
        <button id="taskExportBtn" class="px-3 py-2 bg-green-600 text-white rounded">Export</button>
        <label class="text-sm">Delimiter:</label>
        <select id="taskDelimiter" class="p-2 rounded border bg-white">
          <option value=",">Comma</option>
          <option value="\t">Tab</option>
          <option value=";">Semicolon</option>
          <option value="|">Pipe</option>
          <option value="auto" selected>Auto-detect</option>
        </select>
      </div>

      <textarea id="taskPasteArea" class="w-full h-24 p-2 border rounded hidden" placeholder="Paste tasks lines here... (TrophyLine,Phase,TaskType,Arg1,Arg2,Arg3,Arg4)"></textarea>
      <div id="taskMeta" class="text-sm text-slate-600 mb-2"></div>

      <div class="overflow-x-auto border rounded">
        <table class="min-w-full table-auto text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Trophy Line</th>
              <th class="p-2">Phase</th>
              <th class="p-2">Task Type</th>
              <th class="p-2">Arg 1</th>
              <th class="p-2">Arg 2</th>
              <th class="p-2">Arg 3</th>
              <th class="p-2">Arg 4</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="taskBody"></tbody>
        </table>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="taskAddBtn" class="px-3 py-2 bg-slate-700 text-white rounded">+ Add Task</button>
        <button id="taskSortBtn" class="px-3 py-2 bg-slate-500 text-white rounded">Sort by Trophy</button>
        <button id="taskValidateBtn" class="px-3 py-2 bg-red-600 text-white rounded">Validate</button>
      </div>

      <div id="taskMessages" class="mt-3 text-sm"></div>
    </section>

  </div>

  <!-- ===================== -->
  <!-- JavaScript -->
  <!-- ===================== -->
  <script>
    /* -----------------------
       CompObj Section
    ----------------------- */
    function autoDetectDelimiter(text){
      const sample = text.split(/\r?\n/).map(l=>l.trim()).find(Boolean) || '';
      const candidates=[',','\t',';','|'];
      let best=',';
      let bestCount=0;
      candidates.forEach(del=>{
        const count=sample ? sample.split(del).length : 0;
        if(count>bestCount){ bestCount=count; best=del; }
      });
      return best;
    }

    let rows = [];
    const tbody = document.getElementById('tbody');

    function parseText(text, delimSel='auto') {
      rows = [];
      const delim = (delimSel==='auto') ? autoDetectDelimiter(text) : delimSel;
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for (const line of lines) {
        const parts = line.split(delim).map(p=>p.trim());
        while (parts.length < 5) parts.push('');
        const [id, level, code, name, parent] = parts;
        rows.push({ id, level, code, name, parent });
      }
      document.getElementById('meta').textContent = `${rows.length} lines parsed`;
      renderTable();
    }

    function renderTable(){
      tbody.innerHTML = '';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.className = i%2? 'bg-white':'bg-slate-50';
        tr.innerHTML = `
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="id" data-i="${i}" class="w-24 p-1 border rounded" value="${r.id}"></td>
          <td class="p-2"><input data-f="level" data-i="${i}" class="w-12 p-1 border rounded" value="${r.level}"></td>
          <td class="p-2"><input data-f="code" data-i="${i}" class="w-32 p-1 border rounded" value="${r.code}"></td>
          <td class="p-2"><input data-f="name" data-i="${i}" class="w-56 p-1 border rounded" value="${r.name}"></td>
          <td class="p-2"><input data-f="parent" data-i="${i}" class="w-24 p-1 border rounded" value="${r.parent}"></td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input').forEach(inp=>{
        inp.onchange = ()=>{ rows[+inp.dataset.i][inp.dataset.f]=inp.value; };
      });
      tbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick = ()=>{ rows.splice(+btn.dataset.del,1); renderTable(); };
      });
    }

    document.getElementById('fileInput').onchange = e=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>parseText(reader.result, document.getElementById('delimiter').value);
      reader.readAsText(f);
    };

    document.getElementById('pasteBtn').onclick = ()=>{
      const pa=document.getElementById('pasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('pasteArea').onblur = e=>parseText(e.target.value, document.getElementById('delimiter').value);

    document.getElementById('addLineBtn').onclick = ()=>{ rows.push({id:'',level:'',code:'',name:'',parent:''}); renderTable(); };

    document.getElementById('exportBtn').onclick = ()=>{
      const delim = document.getElementById('delimiter').value==='auto' ? ',' : document.getElementById('delimiter').value;
      const blob = new Blob([rows.map(r=>[r.id,r.level,r.code,r.name,r.parent].join(delim)).join('\n')], {type:'text/plain'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='compobj.txt'; a.click();
    };

    document.getElementById('sortByIdBtn').onclick = ()=>{ rows.sort((a,b)=>Number(a.id)-Number(b.id)); renderTable(); };

    document.getElementById('validateBtn').onclick = ()=>{
      const ids=new Set(rows.map(r=>String(r.id)));
      const probs=[];
      rows.forEach((r,i)=>{
        if(!r.id) probs.push(`Line ${i+1}: Missing ID`);
        if(r.parent && !ids.has(String(r.parent))) probs.push(`Line ${i+1}: Parent ${r.parent} not found`);
      });
      document.getElementById('messages').innerHTML = probs.length ? probs.join('<br>') : 'No validation issues.';
    };

    /* -----------------------
       Advancement Section
    ----------------------- */
    let advRows = [];
    const advBody = document.getElementById('advBody');

    function parseAdv(text){
      advRows = [];
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const [fromId, qualifier, toId, slot] = line.split(',').map(s=>s.trim());
        advRows.push({fromId,qualifier,toId,slot});
      }
      document.getElementById('advMeta').textContent=`${advRows.length} advancement lines parsed`;
      renderAdvTable();
    }

    function renderAdvTable(){
      advBody.innerHTML='';
      advRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.className=i%2?'bg-white':'bg-slate-50';
        tr.innerHTML=`
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="fromId" data-i="${i}" class="w-24 p-1 border rounded" value="${r.fromId}"></td>
          <td class="p-2"><input data-f="qualifier" data-i="${i}" class="w-16 p-1 border rounded" value="${r.qualifier}"></td>
          <td class="p-2"><input data-f="toId" data-i="${i}" class="w-24 p-1 border rounded" value="${r.toId}"></td>
          <td class="p-2"><input data-f="slot" data-i="${i}" class="w-16 p-1 border rounded" value="${r.slot}"></td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        advBody.appendChild(tr);
      });
      advBody.querySelectorAll('input').forEach(inp=>{
        inp.onchange=()=>{advRows[+inp.dataset.i][inp.dataset.f]=inp.value;};
      });
      advBody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{advRows.splice(+btn.dataset.del,1);renderAdvTable();};
      });
    }

    document.getElementById('advFileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>parseAdv(r.result);
      r.readAsText(f);
    };

    document.getElementById('advPasteBtn').onclick=()=>{
      const pa=document.getElementById('advPasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('advPasteArea').onblur=e=>parseAdv(e.target.value);

    document.getElementById('advAddBtn').onclick=()=>{advRows.push({fromId:'',qualifier:'',toId:'',slot:''});renderAdvTable();};

    document.getElementById('advSortBtn').onclick=()=>{advRows.sort((a,b)=>Number(a.fromId)-Number(b.fromId));renderAdvTable();};

    document.getElementById('advExportBtn').onclick=()=>{
      const blob=new Blob([advRows.map(r=>[r.fromId,r.qualifier,r.toId,r.slot].join(',')).join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='advancement.txt';a.click();
    };

    document.getElementById('advValidateBtn').onclick=()=>{
      const ids=new Set(rows.map(r=>String(r.id)));
      const missing=advRows.filter(r=>!ids.has(String(r.fromId))||!ids.has(String(r.toId)));
      const msg=missing.length?`${missing.length} advancement lines reference missing group IDs`:'All advancement links valid.';
      document.getElementById('advMessages').textContent=msg;
    };

    /* -----------------------
       Standings Section
    ----------------------- */
    let standingsRows=[];
    const standingsBody=document.getElementById('standingsBody');

    function updateStandingsMeta(){
      const groupCounts=new Map();
      standingsRows.forEach(r=>{
        if(!r.groupId) return;
        const slotNum=r.slot===''?NaN:Number(r.slot);
        if(!groupCounts.has(r.groupId)) groupCounts.set(r.groupId, Number.isFinite(slotNum)?slotNum+1:1);
        else if(Number.isFinite(slotNum)) groupCounts.set(r.groupId, Math.max(groupCounts.get(r.groupId), slotNum+1));
        else groupCounts.set(r.groupId, groupCounts.get(r.groupId)+1);
      });
      const groupCount=groupCounts.size;
      let maxTeams=0;
      groupCounts.forEach(v=>{if(v>maxTeams) maxTeams=v;});
      const meta=`${standingsRows.length} rows parsed${groupCount?` across ${groupCount} groups`:''}${maxTeams?`. Largest table size: ${maxTeams} teams.`:''}`;
      document.getElementById('standingsMeta').textContent=meta;
    }

    function renderStandingsTable(){
      standingsBody.innerHTML='';
      standingsRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.className=i%2?'bg-white':'bg-slate-50';
        const slotNum=r.slot===''?NaN:Number(r.slot);
        const teamLabel=Number.isFinite(slotNum)?`Team ${slotNum+1}`:'';
        tr.innerHTML=`
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="groupId" data-i="${i}" class="w-28 p-1 border rounded" value="${r.groupId}"></td>
          <td class="p-2"><input data-f="slot" data-i="${i}" class="w-24 p-1 border rounded" value="${r.slot}"></td>
          <td class="p-2 text-slate-600">${teamLabel}</td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        standingsBody.appendChild(tr);
      });
      standingsBody.querySelectorAll('input').forEach(inp=>{
        inp.onchange=()=>{standingsRows[+inp.dataset.i][inp.dataset.f]=inp.value;updateStandingsMeta();};
      });
      standingsBody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{standingsRows.splice(+btn.dataset.del,1);renderStandingsTable();};
      });
      updateStandingsMeta();
    }

    function parseStandings(text){
      standingsRows=[];
      const delim=autoDetectDelimiter(text);
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const parts=line.split(delim).map(s=>s.trim());
        if(!parts[0]) continue;
        const [groupId, slot=''] = parts;
        standingsRows.push({groupId, slot});
      }
      renderStandingsTable();
    }

    document.getElementById('standingsFileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>parseStandings(r.result);
      r.readAsText(f);
    };

    document.getElementById('standingsPasteBtn').onclick=()=>{
      const pa=document.getElementById('standingsPasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('standingsPasteArea').onblur=e=>parseStandings(e.target.value);

    document.getElementById('standingsAddBtn').onclick=()=>{standingsRows.push({groupId:'',slot:''});renderStandingsTable();};

    document.getElementById('standingsSortBtn').onclick=()=>{
      standingsRows.sort((a,b)=>{
        const gDiff=Number(a.groupId||0)-Number(b.groupId||0);
        if(gDiff!==0) return gDiff;
        const slotA=a.slot===''?Number.POSITIVE_INFINITY:Number(a.slot);
        const slotB=b.slot===''?Number.POSITIVE_INFINITY:Number(b.slot);
        return slotA-slotB;
      });
      renderStandingsTable();
    };

    document.getElementById('standingsExportBtn').onclick=()=>{
      const blob=new Blob([standingsRows.map(r=>[r.groupId,r.slot].join(',')).join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='standings.txt';a.click();
    };

    document.getElementById('standingsValidateBtn').onclick=()=>{
      const msgs=[];
      const seen=new Set();
      const groupSlots=new Map();
      standingsRows.forEach((r,i)=>{
        if(!r.groupId) msgs.push(`Row ${i+1}: Missing group ID`);
        if(r.slot==='') msgs.push(`Row ${i+1}: Missing slot value`);
        const slotNum=Number(r.slot);
        if(r.slot!=='' && Number.isNaN(slotNum)) msgs.push(`Row ${i+1}: Slot is not a number`);
        const key=`${r.groupId}|${r.slot}`;
        if(seen.has(key)) msgs.push(`Row ${i+1}: Duplicate group/slot combination (${r.groupId}, ${r.slot})`);
        seen.add(key);
        if(r.groupId){
          if(!groupSlots.has(r.groupId)) groupSlots.set(r.groupId,new Set());
          if(!Number.isNaN(slotNum)) groupSlots.get(r.groupId).add(slotNum);
        }
      });
      groupSlots.forEach((slots,gid)=>{
        if(!slots.has(0)) msgs.push(`Group ${gid} is missing slot 0`);
      });
      document.getElementById('standingsMessages').innerHTML = msgs.length ? msgs.join('<br>') : 'No validation issues.';
    };

    /* -----------------------
       Settings Section
    ----------------------- */
    let settingRows = [];
    const settingsBody=document.getElementById('settingsBody');

    function updateSettingsMeta(){
      document.getElementById('settingsMeta').textContent=`${settingRows.length} setting line${settingRows.length===1?'':'s'} parsed`;
    }

    function renderSettingsTable(){
      settingsBody.innerHTML='';
      settingRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.className=i%2?'bg-white':'bg-slate-50';
        tr.innerHTML=`
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="id" data-i="${i}" class="w-28 p-1 border rounded" value="${r.id ?? ''}"></td>
          <td class="p-2"><input data-f="key" data-i="${i}" class="w-40 p-1 border rounded" value="${r.key ?? ''}"></td>
          <td class="p-2"><input data-f="value" data-i="${i}" class="w-48 p-1 border rounded" value="${r.value ?? ''}"></td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        settingsBody.appendChild(tr);
      });
      settingsBody.querySelectorAll('input').forEach(inp=>{
        inp.onchange=()=>{settingRows[+inp.dataset.i][inp.dataset.f]=inp.value;updateSettingsMeta();};
      });
      settingsBody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{settingRows.splice(+btn.dataset.del,1);renderSettingsTable();};
      });
      updateSettingsMeta();
    }

    function parseSettings(text){
      settingRows=[];
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const parts=line.split(',').map(s=>s.trim());
        const [id='', key='', value=''] = parts;
        if(id || key || value) settingRows.push({id, key, value});
      }
      renderSettingsTable();
    }

    document.getElementById('settingsFileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>parseSettings(r.result);
      r.readAsText(f);
    };

    document.getElementById('settingsPasteBtn').onclick=()=>{
      const pa=document.getElementById('settingsPasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('settingsPasteArea').onblur=e=>parseSettings(e.target.value);

    document.getElementById('settingsAddBtn').onclick=()=>{settingRows.push({id:'',key:'',value:''});renderSettingsTable();};

    document.getElementById('settingsExportBtn').onclick=()=>{
      const blob=new Blob([settingRows.map(r=>[r.id,r.key,r.value].join(',')).join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='settings.txt';a.click();
    };

    document.getElementById('settingsValidateBtn').onclick=()=>{
      const probs=[];
      const ids=new Set(rows.map(r=>String(r.id)));
      settingRows.forEach((r,i)=>{
        if(!r.id) probs.push(`Row ${i+1}: Missing CompObj ID`);
        else if(!ids.has(String(r.id))) probs.push(`Row ${i+1}: CompObj ID ${r.id} not found in CompObj table`);
        if(!r.key) probs.push(`Row ${i+1}: Missing Setting Key`);
        if(!r.value) probs.push(`Row ${i+1}: Missing Setting Value`);
      });
      document.getElementById('settingsMessages').innerHTML = probs.length ? probs.join('<br>') : 'No validation issues.';
    };

    updateSettingsMeta();

    /* -----------------------
       Schedule Section
    ----------------------- */
    let scheduleRows = [];
    const scheduleBody = document.getElementById('scheduleBody');
    const scheduleMetaEl = document.getElementById('scheduleMeta');
    const scheduleMessagesEl = document.getElementById('scheduleMessages');

    function updateScheduleMeta(){
      if(scheduleMetaEl){
        scheduleMetaEl.textContent = `${scheduleRows.length} lines parsed`;
      }
    }

    function renderScheduleTable(){
      scheduleBody.innerHTML='';
      scheduleRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.className=i%2?'bg-white':'bg-slate-50';
        tr.innerHTML=`
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="stage" data-i="${i}" class="w-24 p-1 border rounded" value="${r.stage ?? ''}"></td>
          <td class="p-2"><input data-f="date" data-i="${i}" class="w-24 p-1 border rounded" value="${r.date ?? ''}"></td>
          <td class="p-2"><input data-f="round" data-i="${i}" class="w-20 p-1 border rounded" value="${r.round ?? ''}"></td>
          <td class="p-2"><input data-f="min" data-i="${i}" class="w-24 p-1 border rounded" value="${r.min ?? ''}"></td>
          <td class="p-2"><input data-f="max" data-i="${i}" class="w-24 p-1 border rounded" value="${r.max ?? ''}"></td>
          <td class="p-2"><input data-f="time" data-i="${i}" class="w-24 p-1 border rounded" value="${r.time ?? ''}"></td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        scheduleBody.appendChild(tr);
      });
      scheduleBody.querySelectorAll('input').forEach(inp=>{
        inp.onchange=()=>{scheduleRows[+inp.dataset.i][inp.dataset.f]=inp.value;};
      });
      scheduleBody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{scheduleRows.splice(+btn.dataset.del,1);renderScheduleTable();};
      });
      updateScheduleMeta();
    }

    function parseSchedule(text){
      scheduleRows=[];
      const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const parts=line.split(',').map(s=>s.trim());
        while(parts.length<6) parts.push('');
        const [stage='',date='',round='',min='',max='',time='']=parts;
        scheduleRows.push({stage,date,round,min,max,time});
      }
      renderScheduleTable();
      if(scheduleMessagesEl){
        scheduleMessagesEl.textContent='';
      }
    }

    document.getElementById('scheduleFileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>parseSchedule(reader.result);
      reader.readAsText(f);
    };

    document.getElementById('schedulePasteBtn').onclick=()=>{
      const pa=document.getElementById('schedulePasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('schedulePasteArea').onblur=e=>parseSchedule(e.target.value);

    document.getElementById('scheduleAddBtn').onclick=()=>{
      scheduleRows.push({stage:'',date:'',round:'',min:'',max:'',time:''});
      renderScheduleTable();
    };

    document.getElementById('scheduleExportBtn').onclick=()=>{
      const blob=new Blob([scheduleRows.map(r=>[r.stage,r.date,r.round,r.min,r.max,r.time].join(',')).join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='schedule.txt';a.click();
    };

    document.getElementById('scheduleValidateBtn').onclick=()=>{
      const probs=[];
      const stageIds=new Set(rows.map(r=>String(r.id)));
      const numericFields=[['date','Date ID'],['round','Round #'],['min','Min Games'],['max','Max Games'],['time','Time']];
      scheduleRows.forEach((r,i)=>{
        const rowNum=i+1;
        if(!r.stage) probs.push(`Row ${rowNum}: Missing Stage ID`);
        else if(!stageIds.has(String(r.stage))) probs.push(`Row ${rowNum}: Stage ID ${r.stage} not found in CompObj table`);
        numericFields.forEach(([field,label])=>{
          const val=r[field];
          if(val==='') probs.push(`Row ${rowNum}: Missing ${label}`);
          else if(Number.isNaN(Number(val))) probs.push(`Row ${rowNum}: ${label} must be numeric`);
        });
      });
      scheduleMessagesEl.innerHTML = probs.length ? probs.join('<br>') : 'No validation issues.';
    };

    function applyGlobalIdMapping(mapping){
      if(!mapping) return;
      const mappingLookup=new Map();
      if(mapping instanceof Map){
        mapping.forEach((newId,oldId)=>{mappingLookup.set(String(oldId), newId);});
      } else {
        Object.keys(mapping).forEach(oldId=>{mappingLookup.set(String(oldId), mapping[oldId]);});
      }
      let scheduleChanged=false;
      scheduleRows.forEach(row=>{
        const replacement=mappingLookup.get(String(row.stage));
        if(replacement!==undefined){
          row.stage=replacement;
          scheduleChanged=true;
        }
      });
      if(scheduleChanged){
        renderScheduleTable();
        if(scheduleMessagesEl){
          scheduleMessagesEl.textContent='Schedule updated with new stage references.';
        }
      }
    }
    window.applyGlobalIdMapping=applyGlobalIdMapping;

    updateScheduleMeta();

    /* -----------------------
       Tasks Section
    ----------------------- */
    let taskRows = [];
    const taskBody = document.getElementById('taskBody');

    function parseTasks(text, delimSel='auto'){
      taskRows = [];
      const delim = (delimSel==='auto') ? autoDetectDelimiter(text) : delimSel;
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      for(const line of lines){
        const parts = line.split(delim).map(s=>s.trim());
        while(parts.length<7) parts.push('');
        const [trophyLine, phase, taskType, arg1, arg2, arg3, arg4] = parts;
        taskRows.push({trophyLine, phase, taskType, arg1, arg2, arg3, arg4});
      }
      document.getElementById('taskMeta').textContent=`${taskRows.length} task lines parsed`;
      renderTaskTable();
    }

    function renderTaskTable(){
      taskBody.innerHTML='';
      taskRows.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.className=i%2?'bg-white':'bg-slate-50';
        tr.innerHTML=`
          <td class="p-2">${i+1}</td>
          <td class="p-2"><input data-f="trophyLine" data-i="${i}" class="w-24 p-1 border rounded" value="${r.trophyLine}"></td>
          <td class="p-2"><input data-f="phase" data-i="${i}" class="w-24 p-1 border rounded" value="${r.phase}"></td>
          <td class="p-2"><input data-f="taskType" data-i="${i}" class="w-40 p-1 border rounded" value="${r.taskType}"></td>
          <td class="p-2"><input data-f="arg1" data-i="${i}" class="w-24 p-1 border rounded" value="${r.arg1}"></td>
          <td class="p-2"><input data-f="arg2" data-i="${i}" class="w-24 p-1 border rounded" value="${r.arg2}"></td>
          <td class="p-2"><input data-f="arg3" data-i="${i}" class="w-24 p-1 border rounded" value="${r.arg3}"></td>
          <td class="p-2"><input data-f="arg4" data-i="${i}" class="w-24 p-1 border rounded" value="${r.arg4}"></td>
          <td class="p-2"><button data-del="${i}" class="px-2 py-1 bg-red-500 text-white rounded">Del</button></td>`;
        taskBody.appendChild(tr);
      });
      taskBody.querySelectorAll('input').forEach(inp=>{
        inp.onchange=()=>{taskRows[+inp.dataset.i][inp.dataset.f]=inp.value;};
      });
      taskBody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.onclick=()=>{taskRows.splice(+btn.dataset.del,1);renderTaskTable();};
      });
    }

    document.getElementById('taskFileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>parseTasks(r.result, document.getElementById('taskDelimiter').value);
      r.readAsText(f);
    };

    document.getElementById('taskPasteBtn').onclick=()=>{
      const pa=document.getElementById('taskPasteArea');
      pa.classList.toggle('hidden');
      if(!pa.classList.contains('hidden')) pa.focus();
    };
    document.getElementById('taskPasteArea').onblur=e=>parseTasks(e.target.value, document.getElementById('taskDelimiter').value);

    document.getElementById('taskAddBtn').onclick=()=>{taskRows.push({trophyLine:'',phase:'',taskType:'',arg1:'',arg2:'',arg3:'',arg4:''});renderTaskTable();};

    document.getElementById('taskSortBtn').onclick=()=>{
      taskRows.sort((a,b)=>{
        const diff=Number(a.trophyLine||0)-Number(b.trophyLine||0);
        if(diff!==0) return diff;
        return a.phase.localeCompare(b.phase);
      });
      renderTaskTable();
    };

    document.getElementById('taskExportBtn').onclick=()=>{
      const delimSel=document.getElementById('taskDelimiter').value;
      const delim = delimSel==='auto' ? ',' : delimSel;
      const blob=new Blob([taskRows.map(r=>[r.trophyLine,r.phase,r.taskType,r.arg1,r.arg2,r.arg3,r.arg4].join(delim)).join('\n')],{type:'text/plain'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='tasks.txt';a.click();
    };

    document.getElementById('taskValidateBtn').onclick=()=>{
      const probs=[];
      taskRows.forEach((r,i)=>{
        if(!r.trophyLine) probs.push(`Line ${i+1}: Missing trophy line`);
        if(!r.phase) probs.push(`Line ${i+1}: Missing phase (start/end)`);
        if(!r.taskType) probs.push(`Line ${i+1}: Missing task type`);
      });
      document.getElementById('taskMessages').innerHTML = probs.length ? probs.join('<br>') : 'No validation issues.';
    };

    /* Theme */
    document.getElementById('themeSelect').onchange=()=>{
      const v=document.getElementById('themeSelect').value;
      if(v==='dark'){document.body.classList.add('bg-slate-900','text-slate-100');}
      else{document.body.classList.remove('bg-slate-900','text-slate-100');}
    };

  </script>
</body>
</html>
