<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CompData Studio</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_midnight.min.css"
    />
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <style>
      :root {
        color-scheme: dark;
        --bg: #04070f;
        --bg-panel: rgba(14, 21, 34, 0.82);
        --bg-elevated: rgba(17, 25, 41, 0.92);
        --bg-sidebar: linear-gradient(180deg, rgba(10, 16, 28, 0.9), rgba(4, 7, 15, 0.95));
        --border: rgba(94, 117, 158, 0.35);
        --border-subtle: rgba(94, 117, 158, 0.2);
        --text: #e9f0ff;
        --text-subtle: #90a1c3;
        --accent: #38bdf8;
        --accent-strong: #60a5fa;
        --success: #34d399;
        --warning: #fbbf24;
        --danger: #f87171;
        --sidebar-width: 280px;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        font-size: 15px;
        background: radial-gradient(circle at 15% 20%, rgba(56, 189, 248, 0.12), transparent 45%),
          radial-gradient(circle at 80% 0%, rgba(129, 140, 248, 0.16), transparent 55%),
          var(--bg);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background: transparent;
        color: var(--text);
      }

      .app-shell {
        flex: 1;
        display: flex;
        min-height: 0;
      }

      aside {
        width: var(--sidebar-width);
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border);
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .brand {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .brand h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
      }

      .brand p {
        margin: 0;
        color: var(--text-subtle);
        font-size: 0.85rem;
      }

      .nav {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
      }

      .nav button {
        all: unset;
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.75rem 0.9rem;
        border-radius: 1rem;
        cursor: pointer;
        color: var(--text-subtle);
        border: 1px solid transparent;
        transition: background 160ms ease, color 160ms ease, border 160ms ease;
      }

      .nav button .icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.9rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(56, 189, 248, 0.1);
        font-size: 1.25rem;
      }

      .nav button .label {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .nav button .label strong {
        font-weight: 600;
        color: inherit;
      }

      .nav button .label span {
        font-size: 0.78rem;
        color: var(--text-subtle);
      }

      .nav button:hover,
      .nav button:focus-visible {
        background: rgba(56, 189, 248, 0.18);
        color: var(--text);
        border-color: rgba(56, 189, 248, 0.4);
      }

      .nav button.active {
        background: rgba(56, 189, 248, 0.25);
        color: var(--text);
        border-color: rgba(56, 189, 248, 0.55);
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        background: rgba(10, 16, 28, 0.75);
        backdrop-filter: blur(18px);
      }

      .main-header {
        padding: 1.6rem 2.25rem 1.4rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: space-between;
        align-items: flex-start;
      }

      .main-header .title-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .main-header h2 {
        margin: 0;
        font-weight: 600;
        font-size: 1.5rem;
      }

      .main-header .subtitle {
        margin: 0;
        color: var(--text-subtle);
        font-size: 0.88rem;
        max-width: 560px;
      }

      .badge-tray {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        font-size: 0.74rem;
        font-weight: 500;
        background: rgba(56, 189, 248, 0.16);
        color: var(--accent);
      }

      .badge.warning {
        background: rgba(251, 191, 36, 0.16);
        color: var(--warning);
      }

      .badge.success {
        background: rgba(52, 211, 153, 0.16);
        color: var(--success);
      }

      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      .toolbar button {
        all: unset;
        padding: 0.55rem 0.9rem;
        border-radius: 0.85rem;
        border: 1px solid rgba(148, 163, 184, 0.22);
        background: rgba(18, 28, 44, 0.8);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: transform 130ms ease, border 130ms ease, background 130ms ease;
      }

      .toolbar button.primary {
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.9), rgba(99, 102, 241, 0.85));
        border-color: transparent;
      }

      .toolbar button:hover,
      .toolbar button:focus-visible {
        transform: translateY(-1px);
        border-color: rgba(56, 189, 248, 0.45);
      }

      .toolbar button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }

      .autosave-toggle {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.82rem;
        color: var(--text-subtle);
      }

      .sheet-tabs {
        padding: 0 2.25rem;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        background: rgba(7, 11, 20, 0.8);
      }

      .sheet-tabs button {
        all: unset;
        padding: 0.6rem 0.9rem;
        border-radius: 0.85rem 0.85rem 0 0;
        cursor: pointer;
        border: 1px solid transparent;
        color: var(--text-subtle);
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        transition: background 140ms ease, border 140ms ease;
      }

      .sheet-tabs button.active {
        background: rgba(56, 189, 248, 0.18);
        color: var(--text);
        border-color: rgba(56, 189, 248, 0.4);
        border-bottom-color: transparent;
      }

      .sheet-tabs button:hover,
      .sheet-tabs button:focus-visible {
        color: var(--text);
        border-color: rgba(56, 189, 248, 0.32);
      }

      .workspace-panel {
        flex: 1;
        padding: 1.5rem 2.25rem 1.25rem;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .grid-card {
        flex: 1;
        background: var(--bg-panel);
        border-radius: 1.25rem;
        border: 1px solid var(--border-subtle);
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        min-height: 0;
        box-shadow: 0 32px 70px rgba(12, 18, 30, 0.3);
      }

      #grid {
        flex: 1;
      }

      .status-bar {
        padding: 0.9rem 2.25rem 1.4rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1.2rem;
        color: var(--text-subtle);
        font-size: 0.82rem;
        border-top: 1px solid var(--border-subtle);
        background: rgba(7, 11, 19, 0.85);
      }

      .console-panel {
        border-top: 1px solid var(--border);
        background: rgba(3, 6, 13, 0.92);
        padding: 1.75rem 2.25rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .console-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .console-header h3 {
        margin: 0;
        font-size: 1.05rem;
        font-weight: 600;
      }

      .console-actions {
        display: inline-flex;
        gap: 0.65rem;
      }

      .console-actions button {
        all: unset;
        padding: 0.45rem 0.85rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(94, 117, 158, 0.25);
        background: rgba(12, 18, 30, 0.9);
        font-size: 0.78rem;
        cursor: pointer;
      }

      .console-actions button:hover,
      .console-actions button:focus-visible {
        border-color: rgba(56, 189, 248, 0.45);
        color: var(--text);
      }

      .console-log {
        max-height: 260px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        font-size: 0.82rem;
      }

      .log-entry {
        padding: 0.55rem 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(94, 117, 158, 0.25);
        background: rgba(8, 12, 20, 0.9);
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
        line-height: 1.4;
      }

      .log-entry span.icon {
        font-size: 1rem;
        margin-top: 0.1rem;
      }

      .log-entry.success {
        border-color: rgba(52, 211, 153, 0.45);
      }

      .log-entry.warning {
        border-color: rgba(251, 191, 36, 0.4);
      }

      .log-entry.error {
        border-color: rgba(248, 113, 113, 0.4);
      }

      .working::after {
        content: '';
        position: fixed;
        inset: 0;
        background: rgba(4, 7, 15, 0.35);
        pointer-events: none;
        animation: shimmer 1.2s linear infinite;
      }

      @keyframes shimmer {
        from {
          opacity: 0;
        }
        50% {
          opacity: 0.4;
        }
        to {
          opacity: 0;
        }
      }

      .tabulator {
        background: rgba(10, 16, 28, 0.8);
        border: 1px solid rgba(94, 117, 158, 0.3);
        border-radius: 1rem;
      }

      .tabulator .tabulator-header {
        background: rgba(7, 13, 23, 0.95);
        border-bottom: 1px solid rgba(94, 117, 158, 0.25);
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-subtle);
      }

      .tabulator .tabulator-row.tabulator-selectable:hover {
        background: rgba(56, 189, 248, 0.08);
      }

      .tabulator-row.tabulator-selected {
        background: rgba(56, 189, 248, 0.18);
      }

      .tabulator .tabulator-cell {
        font-size: 0.9rem;
        color: var(--text);
      }

      .tabulator .tabulator-editing {
        background: rgba(56, 189, 248, 0.18);
      }

      @media (max-width: 1080px) {
        aside {
          display: none;
        }
        .app-shell {
          flex-direction: column;
        }
        .sheet-tabs {
          padding: 0 1.5rem;
        }
        .workspace-panel {
          padding: 1.25rem 1.5rem;
        }
        .status-bar {
          padding: 0.85rem 1.5rem 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside>
        <div class="brand">
          <h1>CompData Studio</h1>
          <p>All-in-one FIFA/EA CompData workspace</p>
        </div>
        <div class="nav">
          <button type="button" data-target="compobj.txt">
            <span class="icon">üèÜ</span>
            <span class="label">
              <strong>Competition Structure</strong>
              <span>Hierarchy & stages</span>
            </span>
          </button>
          <button type="button" data-target="schedule.txt">
            <span class="icon">üóìÔ∏è</span>
            <span class="label">
              <strong>Schedule Editor</strong>
              <span>Matches & fixtures</span>
            </span>
          </button>
          <button type="button" data-target="tasks.txt">
            <span class="icon">üîÅ</span>
            <span class="label">
              <strong>Task Automation</strong>
              <span>Runtime workflows</span>
            </span>
          </button>
          <button type="button" data-target="advancement.txt">
            <span class="icon">üß≠</span>
            <span class="label">
              <strong>Advancement Rules</strong>
              <span>Promotion flows</span>
            </span>
          </button>
          <button type="button" data-target="settings.txt">
            <span class="icon">‚öôÔ∏è</span>
            <span class="label">
              <strong>Competition Settings</strong>
              <span>Rules & limits</span>
            </span>
          </button>
          <button type="button" data-target="weather.txt">
            <span class="icon">‚òÅÔ∏è</span>
            <span class="label">
              <strong>Weather Config</strong>
              <span>Match conditions</span>
            </span>
          </button>
          <button type="button" data-target="standings.txt">
            <span class="icon">üìä</span>
            <span class="label">
              <strong>Standings Rules</strong>
              <span>Ranking priorities</span>
            </span>
          </button>
          <button type="button" data-target="objectives.txt">
            <span class="icon">üéØ</span>
            <span class="label">
              <strong>Objectives</strong>
              <span>Career goals</span>
            </span>
          </button>
        </div>
      </aside>
      <main>
        <header class="main-header">
          <div class="title-group">
            <h2 id="active-title">CompData Workspace</h2>
            <p class="subtitle" id="active-description">
              Load a dataset to begin editing. References stay intact as you insert, delete, and reorder rows.
            </p>
            <div class="badge-tray">
              <span class="badge" id="status-dirty">Workspace clean</span>
              <span class="badge" id="status-update">0 references updated</span>
            </div>
          </div>
          <div class="toolbar">
            <button type="button" id="btn-add-row">‚ûï Add Row</button>
            <button type="button" id="btn-delete-row">üóë Delete Row</button>
            <button type="button" id="btn-recalculate">‚≠Æ Recalculate</button>
            <button type="button" id="btn-validate">‚öôÔ∏è Validate</button>
            <button type="button" id="btn-autofix">‚ö° Auto-Fix</button>
            <button type="button" id="btn-save" class="primary">üíæ Save All</button>
            <button type="button" id="btn-export">üì¶ Export ZIP</button>
            <label class="autosave-toggle">
              <input type="checkbox" id="autosave-toggle" />
              Auto Save
            </label>
          </div>
        </header>
        <div class="sheet-tabs" id="sheet-tabs"></div>
        <section class="workspace-panel">
          <div class="grid-card">
            <div id="grid"></div>
          </div>
        </section>
        <footer class="status-bar">
          <span id="status-lines">‚Äî</span>
          <span id="status-references">‚Äî</span>
          <span id="status-saved">‚Äî</span>
        </footer>
      </main>
    </div>
    <section class="console-panel">
      <div class="console-header">
        <h3>Validation & Activity Console</h3>
        <div class="console-actions">
          <button type="button" id="btn-clear-console">Clear Log</button>
        </div>
      </div>
      <div class="console-log" id="console-log"></div>
    </section>
    <script type="module">
      const icons = {
        'compobj.txt': 'üèÜ',
        'schedule.txt': 'üóìÔ∏è',
        'tasks.txt': 'üîÅ',
        'advancement.txt': 'üß≠',
        'settings.txt': '‚öôÔ∏è',
        'weather.txt': '‚òÅÔ∏è',
        'standings.txt': 'üìä',
        'objectives.txt': 'üéØ',
      };

      const navButtons = document.querySelectorAll('aside .nav button');
      const tabsContainer = document.getElementById('sheet-tabs');
      const gridContainer = document.getElementById('grid');
      const statusLines = document.getElementById('status-lines');
      const statusRefs = document.getElementById('status-references');
      const statusSaved = document.getElementById('status-saved');
      const badgeDirty = document.getElementById('status-dirty');
      const badgeUpdate = document.getElementById('status-update');
      const autosaveToggle = document.getElementById('autosave-toggle');
      const consoleLog = document.getElementById('console-log');

      const buttons = {
        add: document.getElementById('btn-add-row'),
        delete: document.getElementById('btn-delete-row'),
        recalc: document.getElementById('btn-recalculate'),
        validate: document.getElementById('btn-validate'),
        autoFix: document.getElementById('btn-autofix'),
        save: document.getElementById('btn-save'),
        export: document.getElementById('btn-export'),
        clearConsole: document.getElementById('btn-clear-console'),
      };

      const state = {
        files: new Map(),
        active: null,
        table: null,
        status: {},
        references: { updated: 0, lineMap: {} },
        autoSave: false,
        pendingSave: null,
        working: false,
      };

      function setWorking(active) {
        state.working = active;
        document.body.classList.toggle('working', active);
      }

      function formatTimeAgo(iso) {
        if (!iso) return 'Never saved';
        const then = new Date(iso);
        if (Number.isNaN(then.getTime())) {
          return 'Never saved';
        }
        const diff = Date.now() - then.getTime();
        if (diff < 0) {
          return 'Saving‚Ä¶';
        }
        const mins = Math.floor(diff / 60000);
        if (mins < 1) {
          return 'Last saved moments ago';
        }
        if (mins < 60) {
          return `Last saved ${mins} min ago`;
        }
        const hours = Math.floor(mins / 60);
        if (hours < 24) {
          return `Last saved ${hours} hr ago`;
        }
        return `Last saved ${then.toLocaleString()}`;
      }

      function logMessage(level, message) {
        const entry = document.createElement('div');
        entry.className = `log-entry ${level}`;
        const iconSpan = document.createElement('span');
        iconSpan.className = 'icon';
        iconSpan.textContent =
          level === 'error' ? '‚õî' : level === 'warning' ? '‚ö†Ô∏è' : level === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        const textSpan = document.createElement('span');
        textSpan.textContent = message;
        entry.append(iconSpan, textSpan);
        consoleLog.append(entry);
        consoleLog.scrollTop = consoleLog.scrollHeight;
      }

      function clearConsole() {
        consoleLog.innerHTML = '';
      }

      function updateStatus(payload) {
        state.status = payload.status || {};
        state.references = payload.references || { updated: 0, lineMap: {} };
        const totalLines = state.status.totalLines ?? 0;
        statusLines.textContent = `${totalLines} lines across workspace`;
        const updates = state.references.updated ?? 0;
        statusRefs.textContent = `${updates} references updated`; 
        badgeUpdate.textContent = `${updates} references updated`;
        const dirty = Boolean(state.status.dirty);
        badgeDirty.textContent = dirty ? 'Unsaved changes' : 'Workspace clean';
        badgeDirty.classList.toggle('warning', dirty);
        statusSaved.textContent = formatTimeAgo(state.status.lastSaved);
      }

      function buildTabButtons(files) {
        tabsContainer.innerHTML = '';
        files.forEach(file => {
          const tab = document.createElement('button');
          tab.type = 'button';
          tab.dataset.name = file.name;
          tab.textContent = `${icons[file.name] || 'üìÑ'} ${file.label}`;
          if (file.name === state.active) {
            tab.classList.add('active');
          }
          tab.addEventListener('click', () => {
            activateFile(file.name);
          });
          tabsContainer.append(tab);
        });
      }

      function applyWorkspace(payload) {
        if (!payload || !payload.files) {
          return;
        }
        state.files = new Map(payload.files.map(file => [file.name, file]));
        updateStatus(payload);
        const target = state.active && state.files.has(state.active) ? state.active : payload.files[0]?.name;
        state.active = target || null;
        buildTabButtons(payload.files);
        if (state.active) {
          renderTable(state.files.get(state.active));
          updateActiveDetails();
        }
        updateToolbarState();
      }

      function updateActiveDetails() {
        const file = state.files.get(state.active);
        const titleEl = document.getElementById('active-title');
        const descEl = document.getElementById('active-description');
        if (!file) {
          titleEl.textContent = 'CompData Workspace';
          descEl.textContent = 'Load a dataset to begin editing.';
          return;
        }
        titleEl.textContent = `${icons[file.name] || 'üìÑ'} ${file.label}`;
        descEl.textContent = file.description || '';
        document.querySelectorAll('.sheet-tabs button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.name === file.name);
        });
        navButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.target === file.name);
        });
      }

      function buildColumns(file) {
        return [
          {
            formatter: 'rownum',
            hozAlign: 'center',
            headerSort: false,
            frozen: true,
            width: 60,
          },
          ...file.columns.map(col => ({
            title: col.label,
            field: col.key,
            editor: col.readOnly ? false : 'input',
            sorter: col.type === 'number' ? 'number' : 'string',
            headerSort: true,
            hozAlign: col.type === 'number' ? 'right' : 'left',
            minWidth: col.type === 'number' ? 120 : 160,
          })),
        ];
      }

      function renderTable(file) {
        if (!file) {
          if (state.table) {
            state.table.destroy();
            state.table = null;
          }
          return;
        }
        if (state.table) {
          state.table.destroy();
          state.table = null;
        }
        gridContainer.innerHTML = '';
        state.table = new Tabulator(gridContainer, {
          data: file.rows || [],
          index: '__id',
          layout: 'fitDataFill',
          reactiveData: true,
          height: '100%',
          selectable: true,
          movableRows: file.name === 'compobj.txt',
          rowHeader: 'rownum',
          columns: buildColumns(file),
        });
        state.table.on('cellEdited', cell => {
          const rowData = cell.getRow().getData();
          mutate(`/api/edit/${file.name}`, {
            rowId: rowData.__id,
            field: cell.getField(),
            value: cell.getValue(),
          });
        });
        state.table.on('rowSelectionChanged', () => updateToolbarState());
        if (file.name === 'compobj.txt') {
          state.table.on('rowMoved', () => {
            const order = state.table.getData().map(row => row.__id);
            mutate(`/api/reorder/${file.name}`, { order }, { message: 'Reordered competition structure.' });
          });
        }
      }

      function updateToolbarState() {
        const file = state.files.get(state.active);
        const hasSelection = Boolean(state.table?.getSelectedData().length);
        buttons.delete.disabled = !hasSelection;
      }

      function activateFile(name) {
        if (!state.files.has(name)) {
          return;
        }
        state.active = name;
        renderTable(state.files.get(name));
        updateActiveDetails();
        updateToolbarState();
      }

      async function fetchWorkspace() {
        setWorking(true);
        try {
          const res = await fetch('/api/state');
          const data = await res.json();
          if (!res.ok || data.ok === false) {
            throw new Error(data.error || 'Unable to load workspace');
          }
          applyWorkspace(data);
          logMessage('success', 'Workspace ready.');
        } catch (error) {
          logMessage('error', error.message);
        } finally {
          setWorking(false);
        }
      }

      function scheduleAutoSave() {
        if (!state.autoSave) {
          return;
        }
        if (state.pendingSave) {
          clearTimeout(state.pendingSave);
        }
        state.pendingSave = setTimeout(() => {
          performSave(true);
        }, 1500);
      }

      async function mutate(url, body = {}, options = {}) {
        setWorking(true);
        try {
          const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });
          const data = await res.json();
          if (!res.ok || data.ok === false) {
            throw new Error(data.error || 'Request failed');
          }
          if (data.files) {
            applyWorkspace(data);
          }
          if (options.message) {
            logMessage('success', options.message);
          }
          if (state.autoSave && !url.endsWith('/save')) {
            scheduleAutoSave();
          }
        } catch (error) {
          logMessage('error', error.message);
        } finally {
          setWorking(false);
        }
      }

      async function performSave(isAuto = false) {
        if (state.pendingSave) {
          clearTimeout(state.pendingSave);
          state.pendingSave = null;
        }
        setWorking(true);
        try {
          const res = await fetch('/api/save', { method: 'POST' });
          const data = await res.json();
          if (!res.ok || data.ok === false) {
            throw new Error(data.error || 'Save failed');
          }
          applyWorkspace(data);
          const savedCount = data.save?.saved?.length ?? 0;
          logMessage('success', `${isAuto ? 'Auto-saved' : 'Saved'} ${savedCount} files.`);
        } catch (error) {
          logMessage('error', error.message);
        } finally {
          setWorking(false);
        }
      }

      async function runValidation() {
        setWorking(true);
        try {
          const res = await fetch('/api/validate', { method: 'POST' });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || 'Validation failed');
          }
          if (data.issues?.length) {
            logMessage(
              data.ok ? 'warning' : 'error',
              `${data.issues.length} validation issues detected.`
            );
            data.issues.forEach(issue => {
              logMessage(
                issue.severity === 'error' ? 'error' : issue.severity === 'warning' ? 'warning' : 'info',
                `${issue.file} line ${issue.line || '?'}: ${issue.message}`
              );
            });
          } else {
            logMessage('success', 'Validation passed with no issues.');
          }
        } catch (error) {
          logMessage('error', error.message);
        } finally {
          setWorking(false);
        }
      }

      async function exportZip() {
        setWorking(true);
        try {
          const res = await fetch('/api/export');
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || 'Export failed');
          }
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'compdata-workspace.zip';
          link.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
          logMessage('success', 'Exported workspace ZIP.');
        } catch (error) {
          logMessage('error', error.message);
        } finally {
          setWorking(false);
        }
      }

      buttons.add.addEventListener('click', () => {
        if (!state.active) return;
        let index = null;
        const selection = state.table?.getSelectedRows?.() || [];
        if (selection.length) {
          index = selection[selection.length - 1].getPosition(true) + 1;
        }
        mutate(`/api/insert/${state.active}`, { index }, { message: 'Inserted new row.' });
      });

      buttons.delete.addEventListener('click', () => {
        if (!state.active || !state.table) return;
        const selected = state.table.getSelectedData();
        const rowIds = selected.map(row => row.__id);
        if (!rowIds.length) {
          logMessage('warning', 'Select a row to delete.');
          return;
        }
        mutate(`/api/delete/${state.active}`, { rowIds }, { message: `Deleted ${rowIds.length} row(s).` });
      });

      buttons.recalc.addEventListener('click', () => {
        mutate('/api/recalculate', {}, { message: 'Recalculated line numbers and references.' });
      });

      buttons.validate.addEventListener('click', () => runValidation());

      buttons.autoFix.addEventListener('click', () => {
        mutate('/api/recalculate', {}, { message: 'Auto-fixed reference map.' });
      });

      buttons.save.addEventListener('click', () => performSave(false));

      buttons.export.addEventListener('click', () => exportZip());

      buttons.clearConsole.addEventListener('click', clearConsole);

      autosaveToggle.addEventListener('change', event => {
        state.autoSave = event.target.checked;
        logMessage('info', state.autoSave ? 'Auto-save enabled.' : 'Auto-save disabled.');
        if (state.autoSave) {
          scheduleAutoSave();
        } else if (state.pendingSave) {
          clearTimeout(state.pendingSave);
          state.pendingSave = null;
        }
      });

      navButtons.forEach(button => {
        button.addEventListener('click', () => {
          const target = button.dataset.target;
          if (state.files.has(target)) {
            activateFile(target);
          }
        });
      });

      fetchWorkspace();
    </script>
  </body>
</html>
